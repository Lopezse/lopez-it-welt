{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/lib/database.ts"],"sourcesContent":["// =====================================================\n// DATABASE CONNECTION - LOPEZ IT WELT\n// =====================================================\n// Erstellt: 2025-01-19\n// Zweck: MySQL-Datenbankverbindung f√ºr Enterprise++ Kundenverwaltung\n// Status: ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT\n// =====================================================\n\nimport mysql from \"mysql2/promise\";\n\n// =====================================================\n// DATENBANK-KONFIGURATION\n// =====================================================\n\nconst dbConfig = {\n  host: process.env.DB_HOST || \"localhost\",\n  port: parseInt(process.env.DB_PORT || \"3306\"),\n  user: process.env.DB_USER || \"root\",\n  password: process.env.DB_PASSWORD || \"\",\n  database: process.env.DB_NAME || \"lopez_erp\",\n  waitForConnections: true,\n  connectionLimit: 10,\n  queueLimit: 0,\n};\n\n// =====================================================\n// CONNECTION POOL\n// =====================================================\n\nlet pool: mysql.Pool | null = null;\n\nlet isInitialized = false;\n\nexport async function getConnection(): Promise<mysql.Pool> {\n  if (!pool) {\n    try {\n      pool = mysql.createPool(dbConfig);\n      console.log(\"‚úÖ MySQL Connection Pool erstellt\");\n\n      // Test-Verbindung\n      const connection = await pool.getConnection();\n      console.log(\"‚úÖ MySQL Verbindung erfolgreich getestet\");\n      connection.release();\n      \n      // Automatische Initialisierung beim ersten Aufruf (nur einmal)\n      if (!isInitialized) {\n        try {\n          console.log(\"üîß Initialisiere Datenbank-Struktur...\");\n          await initializeDatabase();\n          isInitialized = true;\n          console.log(\"‚úÖ Datenbank-Struktur erfolgreich initialisiert\");\n        } catch (initError) {\n          console.error(\"‚ö†Ô∏è Datenbank-Initialisierung fehlgeschlagen (wird ignoriert):\", initError);\n          // Nicht werfen, da die Tabelle m√∂glicherweise bereits existiert\n        }\n      }\n    } catch (error) {\n      console.error(\"‚ùå MySQL Verbindungsfehler:\", error);\n      throw error;\n    }\n  }\n  return pool;\n}\n\n// =====================================================\n// DATENBANK-INITIALISIERUNG\n// =====================================================\n\nexport async function initializeDatabase(): Promise<void> {\n  try {\n    const connection = await getConnection();\n\n    // =====================================================\n    // KUNDEN-HAUPTTABELLE\n    // =====================================================\n    await connection.execute(`\n            CREATE TABLE IF NOT EXISTS lopez_customers (\n                id BIGINT AUTO_INCREMENT PRIMARY KEY,\n                kundennummer VARCHAR(20) UNIQUE NOT NULL,\n                customer_type ENUM('privat', 'firma', 'beh√∂rde', 'partner') NOT NULL,\n                anrede ENUM('Herr', 'Frau', 'Divers', 'Firma', 'Keine Angabe') DEFAULT 'Keine Angabe',\n                titel VARCHAR(50),\n                vorname VARCHAR(100),\n                nachname VARCHAR(100),\n                firmenname VARCHAR(255),\n                email VARCHAR(255) UNIQUE NOT NULL,\n                telefon VARCHAR(50),\n                strasse VARCHAR(255),\n                plz VARCHAR(20),\n                ort VARCHAR(100),\n                land VARCHAR(100) DEFAULT 'Deutschland',\n                status ENUM('aktiv', 'inaktiv', 'gesperrt') DEFAULT 'aktiv',\n                support_level ENUM('Standard', 'Premium', 'SLA 24h', 'SLA 4h') DEFAULT 'Standard',\n                notes TEXT,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n                INDEX idx_kundennummer (kundennummer),\n                INDEX idx_email (email),\n                INDEX idx_status (status),\n                INDEX idx_customer_type (customer_type),\n                INDEX idx_support_level (support_level)\n            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n        `);\n\n    // =====================================================\n    // KUNDEN-NOTIZEN\n    // =====================================================\n    await connection.execute(`\n            CREATE TABLE IF NOT EXISTS lopez_customer_notes (\n                id BIGINT AUTO_INCREMENT PRIMARY KEY,\n                customer_id BIGINT NOT NULL,\n                note TEXT NOT NULL,\n                created_by VARCHAR(100) NOT NULL,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                FOREIGN KEY (customer_id) REFERENCES lopez_customers(id) ON DELETE CASCADE,\n                INDEX idx_customer_id (customer_id),\n                INDEX idx_created_at (created_at)\n            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n        `);\n\n    // =====================================================\n    // KUNDEN-TAGS\n    // =====================================================\n    await connection.execute(`\n            CREATE TABLE IF NOT EXISTS lopez_customer_tags (\n                id BIGINT AUTO_INCREMENT PRIMARY KEY,\n                customer_id BIGINT NOT NULL,\n                tag_name VARCHAR(50) NOT NULL,\n                tag_color VARCHAR(7) DEFAULT '#3B82F6',\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                FOREIGN KEY (customer_id) REFERENCES lopez_customers(id) ON DELETE CASCADE,\n                UNIQUE KEY unique_customer_tag (customer_id, tag_name),\n                INDEX idx_customer_id (customer_id),\n                INDEX idx_tag_name (tag_name)\n            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n        `);\n\n    // =====================================================\n    // AUDIT-LOGS\n    // =====================================================\n    await connection.execute(`\n            CREATE TABLE IF NOT EXISTS lopez_audit_logs (\n                id BIGINT AUTO_INCREMENT PRIMARY KEY,\n                table_name VARCHAR(50) NOT NULL,\n                record_id BIGINT NOT NULL,\n                action ENUM('INSERT', 'UPDATE', 'DELETE', 'LOGIN', 'LOGOUT', '2FA_SETUP', '2FA_VERIFY', 'PASSWORD_CHANGE', 'ROLE_ASSIGN', 'PERMISSION_GRANT') NOT NULL,\n                old_values JSON,\n                new_values JSON,\n                user_id BIGINT NOT NULL,\n                username VARCHAR(100),\n                ip_address VARCHAR(45),\n                user_agent TEXT,\n                session_id VARCHAR(255),\n                risk_level ENUM('LOW', 'MEDIUM', 'HIGH', 'CRITICAL') DEFAULT 'LOW',\n                compliance_category ENUM('DATA_ACCESS', 'DATA_MODIFICATION', 'AUTHENTICATION', 'AUTHORIZATION', 'SYSTEM_CHANGE', 'SECURITY_EVENT') DEFAULT 'DATA_ACCESS',\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                INDEX idx_table_record (table_name, record_id),\n                INDEX idx_user_id (user_id),\n                INDEX idx_username (username),\n                INDEX idx_action (action),\n                INDEX idx_risk_level (risk_level),\n                INDEX idx_compliance_category (compliance_category),\n                INDEX idx_created_at (created_at),\n                INDEX idx_session_id (session_id)\n            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n        `);\n\n    // =====================================================\n    // RBAC/ABAC SYSTEM\n    // =====================================================\n\n    // Benutzer-Tabelle\n    await connection.execute(`\n            CREATE TABLE IF NOT EXISTS lopez_users (\n                id BIGINT AUTO_INCREMENT PRIMARY KEY,\n                username VARCHAR(50) UNIQUE NOT NULL,\n                email VARCHAR(255) UNIQUE NOT NULL,\n                email_external VARCHAR(255),         -- lopezitwelt.de f√ºr externe Kommunikation\n                email_internal VARCHAR(255),         -- lopez-team.de f√ºr interne Kommunikation\n                password_hash VARCHAR(255) NOT NULL,\n                first_name VARCHAR(100) NOT NULL,\n                last_name VARCHAR(100) NOT NULL,\n                display_name VARCHAR(200),           -- \"Ramiro Lopez Rodriguez - Admin\"\n                admin_alias VARCHAR(50),             -- \"r.lopez\", \"r.mclean\"\n                domain_type ENUM('external', 'internal') DEFAULT 'internal',\n                status ENUM('active', 'inactive', 'locked', 'pending') DEFAULT 'pending',\n                last_login TIMESTAMP NULL,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n                INDEX idx_username (username),\n                INDEX idx_email (email),\n                INDEX idx_email_external (email_external),\n                INDEX idx_email_internal (email_internal),\n                INDEX idx_admin_alias (admin_alias),\n                INDEX idx_domain_type (domain_type),\n                INDEX idx_status (status)\n            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n        `);\n\n    // Rollen-Tabelle\n    await connection.execute(`\n            CREATE TABLE IF NOT EXISTS lopez_roles (\n                id BIGINT AUTO_INCREMENT PRIMARY KEY,\n                name VARCHAR(100) UNIQUE NOT NULL,\n                description TEXT,\n                level TINYINT NOT NULL DEFAULT 5,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n                INDEX idx_name (name),\n                INDEX idx_level (level)\n            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n        `);\n\n    // Berechtigungen-Tabelle\n    await connection.execute(`\n            CREATE TABLE IF NOT EXISTS lopez_permissions (\n                id BIGINT AUTO_INCREMENT PRIMARY KEY,\n                resource VARCHAR(100) NOT NULL,\n                action VARCHAR(50) NOT NULL,\n                conditions JSON,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                UNIQUE KEY unique_resource_action (resource, action),\n                INDEX idx_resource (resource),\n                INDEX idx_action (action)\n            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n        `);\n\n    // Benutzer-Rollen-Zuordnung\n    await connection.execute(`\n            CREATE TABLE IF NOT EXISTS lopez_user_roles (\n                id BIGINT AUTO_INCREMENT PRIMARY KEY,\n                user_id BIGINT NOT NULL,\n                role_id BIGINT NOT NULL,\n                assigned_by BIGINT NOT NULL,\n                assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                expires_at TIMESTAMP NULL,\n                FOREIGN KEY (user_id) REFERENCES lopez_users(id) ON DELETE CASCADE,\n                FOREIGN KEY (role_id) REFERENCES lopez_roles(id) ON DELETE CASCADE,\n                FOREIGN KEY (assigned_by) REFERENCES lopez_users(id) ON DELETE CASCADE,\n                UNIQUE KEY unique_user_role (user_id, role_id),\n                INDEX idx_user_id (user_id),\n                INDEX idx_role_id (role_id),\n                INDEX idx_expires_at (expires_at)\n            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n        `);\n\n    // Rollen-Berechtigungen-Zuordnung\n    await connection.execute(`\n            CREATE TABLE IF NOT EXISTS lopez_role_permissions (\n                id BIGINT AUTO_INCREMENT PRIMARY KEY,\n                role_id BIGINT NOT NULL,\n                permission_id BIGINT NOT NULL,\n                granted BOOLEAN DEFAULT TRUE,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                FOREIGN KEY (role_id) REFERENCES lopez_roles(id) ON DELETE CASCADE,\n                FOREIGN KEY (permission_id) REFERENCES lopez_permissions(id) ON DELETE CASCADE,\n                UNIQUE KEY unique_role_permission (role_id, permission_id),\n                INDEX idx_role_id (role_id),\n                INDEX idx_permission_id (permission_id)\n            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n        `);\n\n    // Sessions-Tabelle\n    await connection.execute(`\n            CREATE TABLE IF NOT EXISTS lopez_sessions (\n                id BIGINT AUTO_INCREMENT PRIMARY KEY,\n                user_id BIGINT NOT NULL,\n                session_token VARCHAR(255) UNIQUE NOT NULL,\n                ip_address VARCHAR(45),\n                user_agent TEXT,\n                expires_at TIMESTAMP NOT NULL,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                FOREIGN KEY (user_id) REFERENCES lopez_users(id) ON DELETE CASCADE,\n                INDEX idx_user_id (user_id),\n                INDEX idx_session_token (session_token),\n                INDEX idx_expires_at (expires_at)\n            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n        `);\n\n    // =====================================================\n    // 2FA SYSTEM\n    // =====================================================\n\n    // 2FA-Secrets-Tabelle\n    await connection.execute(`\n            CREATE TABLE IF NOT EXISTS lopez_user_2fa (\n                id BIGINT AUTO_INCREMENT PRIMARY KEY,\n                user_id BIGINT NOT NULL,\n                secret VARCHAR(255) NOT NULL,\n                backup_codes JSON,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n                FOREIGN KEY (user_id) REFERENCES lopez_users(id) ON DELETE CASCADE,\n                UNIQUE KEY unique_user_2fa (user_id),\n                INDEX idx_user_id (user_id)\n            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n        `);\n\n    // 2FA-Verifikationen-Tabelle\n    await connection.execute(`\n            CREATE TABLE IF NOT EXISTS lopez_user_2fa_verifications (\n                id BIGINT AUTO_INCREMENT PRIMARY KEY,\n                user_id BIGINT NOT NULL,\n                token VARCHAR(10) NOT NULL,\n                verified BOOLEAN DEFAULT FALSE,\n                expires_at TIMESTAMP NOT NULL,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                FOREIGN KEY (user_id) REFERENCES lopez_users(id) ON DELETE CASCADE,\n                INDEX idx_user_id (user_id),\n                INDEX idx_token (token),\n                INDEX idx_expires_at (expires_at)\n            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n        `);\n\n    console.log(\"‚úÖ Datenbank-Tabellen erfolgreich erstellt/aktualisiert\");\n  } catch (error) {\n    console.error(\"‚ùå Datenbank-Initialisierungsfehler:\", error);\n    throw error;\n  }\n}\n\n// =====================================================\n// HILFSFUNKTIONEN\n// =====================================================\n\nexport async function closeConnection(): Promise<void> {\n  if (pool) {\n    await pool.end();\n    pool = null;\n    console.log(\"‚úÖ MySQL Connection Pool geschlossen\");\n  }\n}\n\n// =====================================================\n// KUNDENNUMMER-GENERATOR\n// =====================================================\n\nexport async function generateKundennummer(): Promise<string> {\n  try {\n    const connection = await getConnection();\n    \n    // Datums- und Zeitbasiertes Format: YYYYMMDDHHMM-1 (nur ein Trennzeichen vor der Nummer)\n    const now = new Date();\n    const year = now.getFullYear();\n    const month = String(now.getMonth() + 1).padStart(2, \"0\");\n    const day = String(now.getDate()).padStart(2, \"0\");\n    const hour = String(now.getHours()).padStart(2, \"0\");\n    const minute = String(now.getMinutes()).padStart(2, \"0\");\n    const prefix = `${year}${month}${day}${hour}${minute}`;\n    \n    // N√§chste Nummer f√ºr diese Stunde/Minute ermitteln\n    const [rows] = await connection.execute(\n      `SELECT MAX(CAST(SUBSTRING(kundennummer, 13) AS UNSIGNED)) as max_num \n       FROM lopez_customers \n       WHERE kundennummer LIKE ?`,\n      [`${prefix}-%`],\n    );\n\n    const maxNum = (rows as any)[0]?.max_num || 0;\n    const nextNum = maxNum + 1;\n\n    // Format: YYYYMMDDHHMM-1 (z.B. 202511012210-1)\n    return `${prefix}-${nextNum}`;\n  } catch (error) {\n    console.error(\"‚ùå Kundennummer-Generierung fehlgeschlagen:\", error);\n    // Fallback: Timestamp-basiert\n    const now = new Date();\n    const year = now.getFullYear();\n    const month = String(now.getMonth() + 1).padStart(2, \"0\");\n    const day = String(now.getDate()).padStart(2, \"0\");\n    const hour = String(now.getHours()).padStart(2, \"0\");\n    const minute = String(now.getMinutes()).padStart(2, \"0\");\n    const prefix = `${year}${month}${day}${hour}${minute}`;\n    return `${prefix}-${String(Date.now()).slice(-1)}`;\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 462, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/lib/audit-service.ts"],"sourcesContent":["// =====================================================\n// AUDIT SERVICE - LOPEZ IT WELT\n// =====================================================\n// Erstellt: 2025-01-19\n// Zweck: Erweiterte Compliance-Protokollierung\n// Status: ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT\n// =====================================================\n\nimport { getConnection } from \"./database\";\n\n// =====================================================\n// INTERFACES\n// =====================================================\n\nexport interface AuditLog {\n  id?: number;\n  table_name: string;\n  record_id: number;\n  action:\n    | \"INSERT\"\n    | \"UPDATE\"\n    | \"DELETE\"\n    | \"LOGIN\"\n    | \"LOGOUT\"\n    | \"2FA_SETUP\"\n    | \"2FA_VERIFY\"\n    | \"PASSWORD_CHANGE\"\n    | \"ROLE_ASSIGN\"\n    | \"PERMISSION_GRANT\";\n  old_values?: any;\n  new_values?: any;\n  user_id: number;\n  username?: string;\n  ip_address?: string;\n  user_agent?: string;\n  session_id?: string;\n  risk_level: \"LOW\" | \"MEDIUM\" | \"HIGH\" | \"CRITICAL\";\n  compliance_category:\n    | \"DATA_ACCESS\"\n    | \"DATA_MODIFICATION\"\n    | \"AUTHENTICATION\"\n    | \"AUTHORIZATION\"\n    | \"SYSTEM_CHANGE\"\n    | \"SECURITY_EVENT\";\n  created_at?: string;\n}\n\nexport interface AuditFilter {\n  table_name?: string;\n  action?: string;\n  user_id?: number;\n  risk_level?: string;\n  compliance_category?: string;\n  date_from?: string;\n  date_to?: string;\n  page?: number;\n  limit?: number;\n}\n\nexport interface AuditStats {\n  total_logs: number;\n  logs_by_action: Record<string, number>;\n  logs_by_risk_level: Record<string, number>;\n  logs_by_category: Record<string, number>;\n  logs_by_user: Record<string, number>;\n  recent_activity: AuditLog[];\n}\n\n// =====================================================\n// AUDIT SERVICE CLASS\n// =====================================================\n\nexport class AuditService {\n  // =====================================================\n  // AUDIT-LOGGING\n  // =====================================================\n\n  static async logAudit(auditData: Omit<AuditLog, \"id\" | \"created_at\">): Promise<boolean> {\n    try {\n      const connection = await getConnection();\n\n      await connection.execute(\n        `\n                INSERT INTO lopez_audit_logs \n                (table_name, record_id, action, old_values, new_values, user_id, username, ip_address, user_agent, session_id, risk_level, compliance_category)\n                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n            `,\n        [\n          auditData.table_name,\n          auditData.record_id,\n          auditData.action,\n          auditData.old_values ? JSON.stringify(auditData.old_values) : null,\n          auditData.new_values ? JSON.stringify(auditData.new_values) : null,\n          auditData.user_id,\n          auditData.username || null,\n          auditData.ip_address || null,\n          auditData.user_agent || null,\n          auditData.session_id || null,\n          auditData.risk_level,\n          auditData.compliance_category,\n        ],\n      );\n\n      return true;\n    } catch (error) {\n      console.error(\"‚ùå Audit-Logging fehlgeschlagen:\", error);\n      return false;\n    }\n  }\n\n  // =====================================================\n  // SPEZIFISCHE AUDIT-EVENTS\n  // =====================================================\n\n  static async logLogin(\n    userId: number,\n    username: string,\n    ipAddress?: string,\n    userAgent?: string,\n    sessionId?: string,\n  ): Promise<void> {\n    await this.logAudit({\n      table_name: \"lopez_users\",\n      record_id: userId,\n      action: \"LOGIN\",\n      user_id: userId,\n      username,\n      ip_address: ipAddress,\n      user_agent: userAgent,\n      session_id: sessionId,\n      risk_level: \"LOW\",\n      compliance_category: \"AUTHENTICATION\",\n    });\n  }\n\n  static async logLogout(\n    userId: number,\n    username: string,\n    ipAddress?: string,\n    userAgent?: string,\n    sessionId?: string,\n  ): Promise<void> {\n    await this.logAudit({\n      table_name: \"lopez_users\",\n      record_id: userId,\n      action: \"LOGOUT\",\n      user_id: userId,\n      username,\n      ip_address: ipAddress,\n      user_agent: userAgent,\n      session_id: sessionId,\n      risk_level: \"LOW\",\n      compliance_category: \"AUTHENTICATION\",\n    });\n  }\n\n  static async log2FASetup(\n    userId: number,\n    username: string,\n    ipAddress?: string,\n    userAgent?: string,\n  ): Promise<void> {\n    await this.logAudit({\n      table_name: \"lopez_user_2fa\",\n      record_id: userId,\n      action: \"2FA_SETUP\",\n      user_id: userId,\n      username,\n      ip_address: ipAddress,\n      user_agent: userAgent,\n      risk_level: \"MEDIUM\",\n      compliance_category: \"SECURITY_EVENT\",\n    });\n  }\n\n  static async log2FAVerify(\n    userId: number,\n    username: string,\n    success: boolean,\n    ipAddress?: string,\n    userAgent?: string,\n  ): Promise<void> {\n    await this.logAudit({\n      table_name: \"lopez_user_2fa\",\n      record_id: userId,\n      action: \"2FA_VERIFY\",\n      new_values: { success },\n      user_id: userId,\n      username,\n      ip_address: ipAddress,\n      user_agent: userAgent,\n      risk_level: success ? \"LOW\" : \"HIGH\",\n      compliance_category: \"AUTHENTICATION\",\n    });\n  }\n\n  static async logPasswordChange(\n    userId: number,\n    username: string,\n    ipAddress?: string,\n    userAgent?: string,\n  ): Promise<void> {\n    await this.logAudit({\n      table_name: \"lopez_users\",\n      record_id: userId,\n      action: \"PASSWORD_CHANGE\",\n      user_id: userId,\n      username,\n      ip_address: ipAddress,\n      user_agent: userAgent,\n      risk_level: \"MEDIUM\",\n      compliance_category: \"SECURITY_EVENT\",\n    });\n  }\n\n  static async logRoleAssignment(\n    userId: number,\n    targetUserId: number,\n    roleName: string,\n    assignedBy: string,\n    ipAddress?: string,\n    userAgent?: string,\n  ): Promise<void> {\n    await this.logAudit({\n      table_name: \"lopez_user_roles\",\n      record_id: targetUserId,\n      action: \"ROLE_ASSIGN\",\n      new_values: { role_name: roleName, assigned_by: assignedBy },\n      user_id: userId,\n      username: assignedBy,\n      ip_address: ipAddress,\n      user_agent: userAgent,\n      risk_level: \"HIGH\",\n      compliance_category: \"AUTHORIZATION\",\n    });\n  }\n\n  static async logDataAccess(\n    userId: number,\n    username: string,\n    tableName: string,\n    recordId: number,\n    action: string,\n    ipAddress?: string,\n    userAgent?: string,\n  ): Promise<void> {\n    await this.logAudit({\n      table_name: tableName,\n      record_id: recordId,\n      action: action as any,\n      user_id: userId,\n      username,\n      ip_address: ipAddress,\n      user_agent: userAgent,\n      risk_level: \"LOW\",\n      compliance_category: \"DATA_ACCESS\",\n    });\n  }\n\n  static async logDataModification(\n    userId: number,\n    username: string,\n    tableName: string,\n    recordId: number,\n    action: string,\n    oldValues: any,\n    newValues: any,\n    ipAddress?: string,\n    userAgent?: string,\n  ): Promise<void> {\n    await this.logAudit({\n      table_name: tableName,\n      record_id: recordId,\n      action: action as any,\n      old_values: oldValues,\n      new_values: newValues,\n      user_id: userId,\n      username,\n      ip_address: ipAddress,\n      user_agent: userAgent,\n      risk_level: \"MEDIUM\",\n      compliance_category: \"DATA_MODIFICATION\",\n    });\n  }\n\n  // =====================================================\n  // AUDIT-ABFRAGEN\n  // =====================================================\n\n  static async getAuditLogs(\n    filters: AuditFilter = {},\n  ): Promise<{ logs: AuditLog[]; total: number }> {\n    try {\n      const connection = await getConnection();\n\n      const {\n        table_name,\n        action,\n        user_id,\n        risk_level,\n        compliance_category,\n        date_from,\n        date_to,\n        page = 1,\n        limit = 50,\n      } = filters;\n\n      const offset = (page - 1) * limit;\n\n      // WHERE-Bedingungen aufbauen\n      const whereConditions = [];\n      const queryParams = [];\n\n      if (table_name) {\n        whereConditions.push(\"table_name = ?\");\n        queryParams.push(table_name);\n      }\n\n      if (action) {\n        whereConditions.push(\"action = ?\");\n        queryParams.push(action);\n      }\n\n      if (user_id) {\n        whereConditions.push(\"user_id = ?\");\n        queryParams.push(user_id);\n      }\n\n      if (risk_level) {\n        whereConditions.push(\"risk_level = ?\");\n        queryParams.push(risk_level);\n      }\n\n      if (compliance_category) {\n        whereConditions.push(\"compliance_category = ?\");\n        queryParams.push(compliance_category);\n      }\n\n      if (date_from) {\n        whereConditions.push(\"created_at >= ?\");\n        queryParams.push(date_from);\n      }\n\n      if (date_to) {\n        whereConditions.push(\"created_at <= ?\");\n        queryParams.push(date_to);\n      }\n\n      const whereClause =\n        whereConditions.length > 0 ? `WHERE ${whereConditions.join(\" AND \")}` : \"\";\n\n      // Gesamtanzahl ermitteln\n      const countQuery = `SELECT COUNT(*) as total FROM lopez_audit_logs ${whereClause}`;\n      const [countRows] = await connection.execute(countQuery, queryParams);\n      const total = (countRows as any)[0].total;\n\n      // Logs laden\n      const logsQuery = `\n                SELECT * FROM lopez_audit_logs \n                ${whereClause}\n                ORDER BY created_at DESC\n                LIMIT ? OFFSET ?\n            `;\n\n      const [logRows] = await connection.execute(logsQuery, [...queryParams, limit, offset]);\n\n      return {\n        logs: logRows as AuditLog[],\n        total,\n      };\n    } catch (error) {\n      console.error(\"‚ùå Audit-Logs-Abfrage fehlgeschlagen:\", error);\n      throw error;\n    }\n  }\n\n  static async getAuditStats(dateFrom?: string, dateTo?: string): Promise<AuditStats> {\n    try {\n      const connection = await getConnection();\n\n      const dateFilter = dateFrom && dateTo ? `WHERE created_at BETWEEN ? AND ?` : \"\";\n      const dateParams = dateFrom && dateTo ? [dateFrom, dateTo] : [];\n\n      // Gesamtanzahl\n      const [totalRows] = await connection.execute(\n        `SELECT COUNT(*) as total FROM lopez_audit_logs ${dateFilter}`,\n        dateParams,\n      );\n      const total_logs = (totalRows as any)[0].total;\n\n      // Nach Aktion\n      const [actionRows] = await connection.execute(\n        `SELECT action, COUNT(*) as count FROM lopez_audit_logs ${dateFilter} GROUP BY action`,\n        dateParams,\n      );\n      const logs_by_action = (actionRows as any[]).reduce((acc, row) => {\n        acc[row.action] = row.count;\n        return acc;\n      }, {});\n\n      // Nach Risiko-Level\n      const [riskRows] = await connection.execute(\n        `SELECT risk_level, COUNT(*) as count FROM lopez_audit_logs ${dateFilter} GROUP BY risk_level`,\n        dateParams,\n      );\n      const logs_by_risk_level = (riskRows as any[]).reduce((acc, row) => {\n        acc[row.risk_level] = row.count;\n        return acc;\n      }, {});\n\n      // Nach Kategorie\n      const [categoryRows] = await connection.execute(\n        `SELECT compliance_category, COUNT(*) as count FROM lopez_audit_logs ${dateFilter} GROUP BY compliance_category`,\n        dateParams,\n      );\n      const logs_by_category = (categoryRows as any[]).reduce((acc, row) => {\n        acc[row.compliance_category] = row.count;\n        return acc;\n      }, {});\n\n      // Nach Benutzer\n      const [userRows] = await connection.execute(\n        `SELECT username, COUNT(*) as count FROM lopez_audit_logs ${dateFilter} GROUP BY username ORDER BY count DESC LIMIT 10`,\n        dateParams,\n      );\n      const logs_by_user = (userRows as any[]).reduce((acc, row) => {\n        acc[row.username] = row.count;\n        return acc;\n      }, {});\n\n      // Letzte Aktivit√§ten\n      const [recentRows] = await connection.execute(\n        `SELECT * FROM lopez_audit_logs ${dateFilter} ORDER BY created_at DESC LIMIT 10`,\n        dateParams,\n      );\n      const recent_activity = recentRows as AuditLog[];\n\n      return {\n        total_logs,\n        logs_by_action,\n        logs_by_risk_level,\n        logs_by_category,\n        logs_by_user,\n        recent_activity,\n      };\n    } catch (error) {\n      console.error(\"‚ùå Audit-Statistiken fehlgeschlagen:\", error);\n      throw error;\n    }\n  }\n\n  // =====================================================\n  // COMPLIANCE-REPORTING\n  // =====================================================\n\n  static async generateComplianceReport(dateFrom: string, dateTo: string): Promise<any> {\n    try {\n      const stats = await this.getAuditStats(dateFrom, dateTo);\n\n      return {\n        report_period: { from: dateFrom, to: dateTo },\n        generated_at: new Date().toISOString(),\n        summary: {\n          total_events: stats.total_logs,\n          high_risk_events: stats.logs_by_risk_level.HIGH || 0,\n          critical_events: stats.logs_by_risk_level.CRITICAL || 0,\n          security_events: stats.logs_by_category.SECURITY_EVENT || 0,\n          data_modifications: stats.logs_by_category.DATA_MODIFICATION || 0,\n        },\n        details: stats,\n      };\n    } catch (error) {\n      console.error(\"‚ùå Compliance-Report fehlgeschlagen:\", error);\n      throw error;\n    }\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 783, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/lib/2fa-service.ts"],"sourcesContent":["// =====================================================\n// 2FA SERVICE - LOPEZ IT WELT\n// =====================================================\n// Erstellt: 2025-01-19\n// Zweck: Zwei-Faktor-Authentifizierung f√ºr Admin-Zugang\n// Status: ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT\n// =====================================================\n\nimport QRCode from \"qrcode\";\nimport speakeasy from \"speakeasy\";\nimport { getConnection } from \"./database\";\n\n// =====================================================\n// INTERFACES\n// =====================================================\n\nexport interface TwoFactorSecret {\n  secret: string;\n  qrCodeUrl: string;\n  backupCodes: string[];\n}\n\nexport interface TwoFactorVerification {\n  userId: number;\n  token: string;\n  verified: boolean;\n  expiresAt: Date;\n}\n\n// =====================================================\n// 2FA SERVICE CLASS\n// =====================================================\n\nexport class TwoFactorService {\n  // =====================================================\n  // 2FA-SETUP\n  // =====================================================\n\n  static async setup2FA(userId: number, email?: string, username?: string): Promise<TwoFactorSecret> {\n    try {\n      // Speakeasy Secret generieren (Aegis-kompatibel: TOTP, 30 Sek. Intervalle, 6-stellig)\n      const secret = speakeasy.generateSecret({\n        name: email || username || `user_${userId}`,\n        issuer: \"Lopez IT Welt\",\n        length: 32,\n      });\n\n      // otpauth URL f√ºr Aegis/Google Authenticator (TOTP, 30 Sekunden, 6-stellig)\n      const otpauthUrl = speakeasy.otpauthURL({\n        secret: secret.base32,\n        label: email || username || `user_${userId}`,\n        issuer: \"Lopez IT Welt\",\n        encoding: \"base32\",\n        algorithm: \"sha1\",\n        digits: 6,\n        period: 30, // 30 Sekunden (Aegis-kompatibel)\n      });\n\n      // QR-Code generieren\n      const qrCodeUrl = await QRCode.toDataURL(otpauthUrl);\n\n      // Backup-Codes generieren\n      const backupCodes = this.generateBackupCodes();\n\n      // Secret in Datenbank speichern (noch nicht aktiviert, erst nach Verifikation)\n      // Das Secret wird erst nach erfolgreicher Verifikation aktiviert\n      \n      return {\n        secret: secret.base32!,\n        qrCodeUrl,\n        backupCodes,\n      };\n    } catch (error) {\n      console.error(\"‚ùå 2FA-Setup fehlgeschlagen:\", error);\n      throw error;\n    }\n  }\n\n  // =====================================================\n  // 2FA-VERIFIKATION\n  // =====================================================\n\n  static async verifyToken(userId: number, token: string): Promise<boolean> {\n    try {\n      // User Secret aus Datenbank laden\n      const userSecret = await this.getUserSecret(userId);\n      if (!userSecret) {\n        return false;\n      }\n\n      // Token verifizieren\n      const verified = speakeasy.totp.verify({\n        secret: userSecret.secret,\n        token: token,\n        window: 2, // 2 Zeitfenster Toleranz\n      });\n\n      if (verified) {\n        // Verifikation in Datenbank speichern\n        await this.saveVerification(userId, token, true);\n        return true;\n      }\n\n      // Backup-Code pr√ºfen\n      const backupVerified = await this.verifyBackupCode(userId, token);\n      if (backupVerified) {\n        await this.saveVerification(userId, token, true);\n        return true;\n      }\n\n      return false;\n    } catch (error) {\n      console.error(\"‚ùå 2FA-Verifikation fehlgeschlagen:\", error);\n      return false;\n    }\n  }\n\n  // =====================================================\n  // BACKUP-CODES\n  // =====================================================\n\n  static async generateNewBackupCodes(userId: number): Promise<string[]> {\n    try {\n      const backupCodes = this.generateBackupCodes();\n      await this.updateUserBackupCodes(userId, backupCodes);\n      return backupCodes;\n    } catch (error) {\n      console.error(\"‚ùå Backup-Codes-Generierung fehlgeschlagen:\", error);\n      throw error;\n    }\n  }\n\n  static async verifyBackupCode(userId: number, code: string): Promise<boolean> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\n        \"SELECT backup_codes FROM lopez_user_2fa WHERE user_id = ?\",\n        [userId],\n      );\n\n      if ((rows as any[]).length === 0) {\n        return false;\n      }\n\n      const backupCodes = JSON.parse((rows as any)[0].backup_codes);\n      const index = backupCodes.indexOf(code);\n\n      if (index !== -1) {\n        // Backup-Code entfernen (einmalig verwendbar)\n        backupCodes.splice(index, 1);\n        await this.updateUserBackupCodes(userId, backupCodes);\n        return true;\n      }\n\n      return false;\n    } catch (error) {\n      console.error(\"‚ùå Backup-Code-Verifikation fehlgeschlagen:\", error);\n      return false;\n    }\n  }\n\n  // =====================================================\n  // 2FA-STATUS\n  // =====================================================\n\n  static async is2FAEnabled(userId: number): Promise<boolean> {\n    try {\n      const userSecret = await this.getUserSecret(userId);\n      return userSecret !== null;\n    } catch (error) {\n      console.error(\"‚ùå 2FA-Status-Pr√ºfung fehlgeschlagen:\", error);\n      return false;\n    }\n  }\n\n  static async disable2FA(userId: number): Promise<boolean> {\n    try {\n      const connection = await getConnection();\n      await connection.execute(\"DELETE FROM lopez_user_2fa WHERE user_id = ?\", [userId]);\n\n      console.log(`‚úÖ 2FA f√ºr Benutzer ${userId} deaktiviert`);\n      return true;\n    } catch (error) {\n      console.error(\"‚ùå 2FA-Deaktivierung fehlgeschlagen:\", error);\n      return false;\n    }\n  }\n\n  // =====================================================\n  // HILFSFUNKTIONEN\n  // =====================================================\n\n  private static generateBackupCodes(): string[] {\n    const codes: string[] = [];\n    for (let i = 0; i < 10; i++) {\n      codes.push(this.generateRandomCode(8));\n    }\n    return codes;\n  }\n\n  private static generateRandomCode(length: number): string {\n    const chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\";\n    let result = \"\";\n    for (let i = 0; i < length; i++) {\n      result += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return result;\n  }\n\n  private static async saveUserSecret(\n    userId: number,\n    secret: string,\n    backupCodes: string[],\n  ): Promise<void> {\n    try {\n      const connection = await getConnection();\n      await connection.execute(\n        `\n                INSERT INTO lopez_user_2fa (user_id, secret, backup_codes, created_at)\n                VALUES (?, ?, ?, NOW())\n                ON DUPLICATE KEY UPDATE\n                secret = VALUES(secret),\n                backup_codes = VALUES(backup_codes),\n                updated_at = NOW()\n            `,\n        [userId, secret, JSON.stringify(backupCodes)],\n      );\n    } catch (error) {\n      console.error(\"‚ùå User Secret speichern fehlgeschlagen:\", error);\n      throw error;\n    }\n  }\n\n  private static async getUserSecret(\n    userId: number,\n  ): Promise<{ secret: string; backupCodes: string[] } | null> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\n        \"SELECT secret, backup_codes FROM lopez_user_2fa WHERE user_id = ?\",\n        [userId],\n      );\n\n      if ((rows as any[]).length === 0) {\n        return null;\n      }\n\n      const row = (rows as any)[0];\n      return {\n        secret: row.secret,\n        backupCodes: JSON.parse(row.backup_codes),\n      };\n    } catch (error) {\n      console.error(\"‚ùå User Secret laden fehlgeschlagen:\", error);\n      return null;\n    }\n  }\n\n  private static async updateUserBackupCodes(userId: number, backupCodes: string[]): Promise<void> {\n    try {\n      const connection = await getConnection();\n      await connection.execute(\n        \"UPDATE lopez_user_2fa SET backup_codes = ?, updated_at = NOW() WHERE user_id = ?\",\n        [JSON.stringify(backupCodes), userId],\n      );\n    } catch (error) {\n      console.error(\"‚ùå Backup-Codes aktualisieren fehlgeschlagen:\", error);\n      throw error;\n    }\n  }\n\n  private static async saveVerification(\n    userId: number,\n    token: string,\n    verified: boolean,\n  ): Promise<void> {\n    try {\n      const connection = await getConnection();\n      const expiresAt = new Date(Date.now() + 5 * 60 * 1000); // 5 Minuten\n\n      await connection.execute(\n        `\n                INSERT INTO lopez_user_2fa_verifications (user_id, token, verified, expires_at, created_at)\n                VALUES (?, ?, ?, ?, NOW())\n            `,\n        [userId, token, verified, expiresAt],\n      );\n    } catch (error) {\n      console.error(\"‚ùå 2FA-Verifikation speichern fehlgeschlagen:\", error);\n    }\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1059, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/lib/email-service.ts"],"sourcesContent":["// =====================================================\n// EMAIL SERVICE - LOPEZ IT WELT\n// =====================================================\n// Erstellt: 2025-01-19\n// Zweck: E-Mail-Versand f√ºr Kundenverwaltung\n// Status: ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT\n// =====================================================\n\nimport nodemailer from \"nodemailer\";\nimport { Customer } from \"./customer-service\";\n\n// =====================================================\n// INTERFACES\n// =====================================================\n\nexport interface EmailData {\n  to: string;\n  subject: string;\n  html: string;\n  text: string;\n}\n\nexport interface UserEmailData {\n  first_name: string;\n  last_name: string;\n  domain_type: \"external\" | \"internal\";\n  admin_alias?: string;\n}\n\n// =====================================================\n// EMAIL SERVICE CLASS\n// =====================================================\n\nexport class EmailService {\n  private transporter: nodemailer.Transporter;\n\n  constructor() {\n    this.transporter = nodemailer.createTransporter({\n      host: process.env.SMTP_HOST || \"localhost\",\n      port: parseInt(process.env.SMTP_PORT || \"587\"),\n      secure: process.env.SMTP_SECURE === \"true\",\n      auth: {\n        user: process.env.SMTP_USER || \"\",\n        pass: process.env.SMTP_PASS || \"\",\n      },\n    });\n  }\n\n  // =====================================================\n  // E-MAIL-VERSAND\n  // =====================================================\n\n  async sendEmail(emailData: EmailData): Promise<boolean> {\n    try {\n      const mailOptions = {\n        from: process.env.SMTP_FROM || \"noreply@lopez-it-welt.de\",\n        to: emailData.to,\n        subject: emailData.subject,\n        text: emailData.text,\n        html: emailData.html,\n      };\n\n      const result = await this.transporter.sendMail(mailOptions);\n      console.log(\"‚úÖ E-Mail erfolgreich versendet:\", result.messageId);\n      return true;\n    } catch (error) {\n      console.error(\"‚ùå E-Mail-Versand fehlgeschlagen:\", error);\n      return false;\n    }\n  }\n\n  // =====================================================\n  // KUNDEN-E-MAILS\n  // =====================================================\n\n  async sendCustomerWelcome(customer: Customer): Promise<boolean> {\n    const subject = \"Willkommen bei Lopez IT Welt\";\n    const html = this.getWelcomeHTML(customer);\n    const text = this.getWelcomeText(customer);\n\n    return await this.sendEmail({ to: customer.email, subject, html, text });\n  }\n\n  async sendCustomerUpdate(customer: Customer, changes: string[]): Promise<boolean> {\n    const subject = \"Ihre Kundendaten wurden aktualisiert\";\n    const html = this.getUpdateHTML(customer, changes);\n    const text = this.getUpdateText(customer, changes);\n\n    return await this.sendEmail({ to: customer.email, subject, html, text });\n  }\n\n  // =====================================================\n  // ADMIN-E-MAILS\n  // =====================================================\n\n  async sendAdminNotification(\n    subject: string,\n    message: string,\n    adminEmails: string[],\n  ): Promise<boolean> {\n    const html = this.getAdminNotificationHTML(subject, message);\n    const text = this.getAdminNotificationText(subject, message);\n\n    return await this.sendEmail({\n      to: adminEmails.join(\", \"),\n      subject,\n      html,\n      text,\n    });\n  }\n\n  // =====================================================\n  // E-MAIL-TEMPLATES\n  // =====================================================\n\n  private getWelcomeHTML(customer: Customer): string {\n    return `\n            <!DOCTYPE html>\n            <html>\n            <head>\n                <meta charset=\"utf-8\">\n                <title>Willkommen bei Lopez IT Welt</title>\n                <style>\n                    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n                    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n                    .header { background: #1e40af; color: white; padding: 20px; text-align: center; }\n                    .content { padding: 20px; background: #f8fafc; }\n                    .footer { background: #64748b; color: white; padding: 15px; text-align: center; font-size: 12px; }\n                </style>\n            </head>\n            <body>\n                <div class=\"container\">\n                    <div class=\"header\">\n                        <h1>Willkommen bei Lopez IT Welt</h1>\n                    </div>\n                    <div class=\"content\">\n                        <h2>Hallo ${customer.anrede} ${customer.vorname} ${customer.nachname},</h2>\n                        <p>herzlich willkommen in unserem Kundenverwaltungssystem!</p>\n                        <p><strong>Ihre Kundendaten:</strong></p>\n                        <ul>\n                            <li>Kundennummer: ${customer.kundennummer}</li>\n                            <li>E-Mail: ${customer.email}</li>\n                            <li>Support-Level: ${customer.support_level}</li>\n                            <li>Status: ${customer.status}</li>\n                        </ul>\n                        <p>Bei Fragen stehen wir Ihnen gerne zur Verf√ºgung.</p>\n                        <p>Mit freundlichen Gr√º√üen<br>Ihr Lopez IT Welt Team</p>\n                    </div>\n                    <div class=\"footer\">\n                        <p>¬© 2025 Lopez IT Welt - Vertraulich</p>\n                    </div>\n                </div>\n            </body>\n            </html>\n        `;\n  }\n\n  private getWelcomeText(customer: Customer): string {\n    return `\n            Willkommen bei Lopez IT Welt\n            \n            Hallo ${customer.anrede} ${customer.vorname} ${customer.nachname},\n            \n            herzlich willkommen in unserem Kundenverwaltungssystem!\n            \n            Ihre Kundendaten:\n            - Kundennummer: ${customer.kundennummer}\n            - E-Mail: ${customer.email}\n            - Support-Level: ${customer.support_level}\n            - Status: ${customer.status}\n            \n            Bei Fragen stehen wir Ihnen gerne zur Verf√ºgung.\n            \n            Mit freundlichen Gr√º√üen\n            Ihr Lopez IT Welt Team\n            \n            ¬© 2025 Lopez IT Welt - Vertraulich\n        `;\n  }\n\n  private getUpdateHTML(customer: Customer, changes: string[]): string {\n    return `\n            <!DOCTYPE html>\n            <html>\n            <head>\n                <meta charset=\"utf-8\">\n                <title>Kundendaten aktualisiert</title>\n                <style>\n                    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n                    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n                    .header { background: #1e40af; color: white; padding: 20px; text-align: center; }\n                    .content { padding: 20px; background: #f8fafc; }\n                    .footer { background: #64748b; color: white; padding: 15px; text-align: center; font-size: 12px; }\n                </style>\n            </head>\n            <body>\n                <div class=\"container\">\n                    <div class=\"header\">\n                        <h1>Kundendaten aktualisiert</h1>\n                    </div>\n                    <div class=\"content\">\n                        <h2>Hallo ${customer.anrede} ${customer.vorname} ${customer.nachname},</h2>\n                        <p>Ihre Kundendaten wurden erfolgreich aktualisiert.</p>\n                        <p><strong>Ge√§nderte Felder:</strong> ${changes.join(\", \")}</p>\n                        <p>Bei Fragen stehen wir Ihnen gerne zur Verf√ºgung.</p>\n                        <p>Mit freundlichen Gr√º√üen<br>Ihr Lopez IT Welt Team</p>\n                    </div>\n                    <div class=\"footer\">\n                        <p>¬© 2025 Lopez IT Welt - Vertraulich</p>\n                    </div>\n                </div>\n            </body>\n            </html>\n        `;\n  }\n\n  private getUpdateText(customer: Customer, changes: string[]): string {\n    return `\n            Kundendaten aktualisiert\n            \n            Hallo ${customer.anrede} ${customer.vorname} ${customer.nachname},\n            \n            Ihre Kundendaten wurden erfolgreich aktualisiert.\n            \n            Ge√§nderte Felder: ${changes.join(\", \")}\n            \n            Bei Fragen stehen wir Ihnen gerne zur Verf√ºgung.\n            \n            Mit freundlichen Gr√º√üen\n            Ihr Lopez IT Welt Team\n            \n            ¬© 2025 Lopez IT Welt - Vertraulich\n        `;\n  }\n\n  private getAdminNotificationHTML(subject: string, message: string): string {\n    return `\n            <!DOCTYPE html>\n            <html>\n            <head>\n                <meta charset=\"utf-8\">\n                <title>Admin-Benachrichtigung</title>\n                <style>\n                    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n                    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n                    .header { background: #dc2626; color: white; padding: 20px; text-align: center; }\n                    .content { padding: 20px; background: #f8fafc; }\n                    .footer { background: #64748b; color: white; padding: 15px; text-align: center; font-size: 12px; }\n                </style>\n            </head>\n            <body>\n                <div class=\"container\">\n                    <div class=\"header\">\n                        <h1>Admin-Benachrichtigung</h1>\n                    </div>\n                    <div class=\"content\">\n                        <h2>${subject}</h2>\n                        <p>${message}</p>\n                        <p><strong>Zeitstempel:</strong> ${new Date().toLocaleString(\"de-DE\")}</p>\n                    </div>\n                    <div class=\"footer\">\n                        <p>¬© 2025 Lopez IT Welt - Vertraulich</p>\n                    </div>\n                </div>\n            </body>\n            </html>\n        `;\n  }\n\n  private getAdminNotificationText(subject: string, message: string): string {\n    return `\n            Admin-Benachrichtigung\n            \n            ${subject}\n            \n            ${message}\n            \n            Zeitstempel: ${new Date().toLocaleString(\"de-DE\")}\n            \n            ¬© 2025 Lopez IT Welt - Vertraulich\n        `;\n  }\n\n  // =====================================================\n  // E-MAIL-VALIDIERUNG\n  // =====================================================\n\n  async validateEmail(email: string): Promise<boolean> {\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    return emailRegex.test(email);\n  }\n\n  // =====================================================\n  // DOMAIN-STRATEGIE METHODS\n  // =====================================================\n\n  /**\n   * Generiert E-Mail-Adresse basierend auf Domain-Strategie\n   * Gesetzliche Namenskonvention: Doppel-Nachname zusammen + Vorname\n   */\n  static generateEmailAddress(userData: UserEmailData): string {\n    const { first_name, last_name, domain_type } = userData;\n\n    // Gesetzliche Namenskonvention: Doppel-Nachname zusammenf√ºgen\n    const cleanFirstName = first_name.toLowerCase().replace(/[^a-z√§√∂√º√ü]/g, \"\");\n    const cleanLastName = last_name\n      .toLowerCase()\n      .replace(/[^a-z√§√∂√º√ü]/g, \"\")\n      .replace(/\\s+/g, \"\");\n    const domain = domain_type === \"external\" ? \"lopezitwelt.de\" : \"lopez-team.de\";\n\n    return `${cleanFirstName}.${cleanLastName}@${domain}`;\n  }\n\n  /**\n   * Generiert Display-Name f√ºr Benutzer\n   */\n  static generateDisplayName(firstName: string, lastName: string, role?: string): string {\n    const fullName = `${firstName} ${lastName}`;\n    return role ? `${fullName} - ${role}` : fullName;\n  }\n\n  /**\n   * Validiert E-Mail-Adresse basierend auf Domain-Strategie\n   */\n  static validateEmailDomain(email: string, domainType: \"external\" | \"internal\"): boolean {\n    const expectedDomain = domainType === \"external\" ? \"lopezitwelt.de\" : \"lopez-team.de\";\n    return email.endsWith(`@${expectedDomain}`);\n  }\n\n  // =====================================================\n  // E-MAIL-KONFIGURATION TESTEN\n  // =====================================================\n\n  async testConnection(): Promise<boolean> {\n    try {\n      await this.transporter.verify();\n      console.log(\"‚úÖ E-Mail-Verbindung erfolgreich getestet\");\n      return true;\n    } catch (error) {\n      console.error(\"‚ùå E-Mail-Verbindung fehlgeschlagen:\", error);\n      return false;\n    }\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1359, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/lib/domain-strategy.ts"],"sourcesContent":["// =====================================================\n// DOMAIN STRATEGY - LOPEZ IT WELT\n// =====================================================\n// Erstellt: 2025-09-20\n// Zweck: Domain-Strategie Implementation (lopezitwelt.de / lopez-team.de)\n// Status: ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT\n// =====================================================\n\nimport { EmailService } from \"./email-service\";\n\n// =====================================================\n// INTERFACES\n// =====================================================\n\nexport interface DomainUser {\n  first_name: string;\n  last_name: string;\n  role: string;\n  domain_type: \"external\" | \"internal\";\n}\n\n// =====================================================\n// DOMAIN STRATEGY CLASS\n// =====================================================\n\nexport class DomainStrategy {\n  // =====================================================\n  // CHEF-BENUTZER ERSTELLEN\n  // =====================================================\n\n  /**\n   * Erstellt Chef-Benutzer (ramiro.lopezrodriguez)\n   */\n  static createChefUser(): DomainUser {\n    return {\n      first_name: \"Ramiro\",\n      last_name: \"Lopez Rodriguez\",\n      role: \"Chef\",\n      domain_type: \"external\",\n    };\n  }\n\n  /**\n   * Erstellt Sohn-Benutzer (ramiro.lopezmclean)\n   */\n  static createSohnUser(): DomainUser {\n    return {\n      first_name: \"Ramiro\",\n      last_name: \"Lopez Mc Lean\",\n      role: \"CTO\",\n      domain_type: \"external\",\n    };\n  }\n\n  // =====================================================\n  // E-MAIL-GENERIERUNG\n  // =====================================================\n\n  /**\n   * Generiert alle E-Mail-Adressen f√ºr einen Benutzer\n   * Gesetzliche Namenskonvention: Doppel-Nachname zusammen + Vorname\n   */\n  static generateUserEmails(user: DomainUser): {\n    external: string;\n    internal: string;\n    display_name: string;\n  } {\n    const externalEmail = EmailService.generateEmailAddress({\n      first_name: user.first_name,\n      last_name: user.last_name,\n      domain_type: \"external\",\n    });\n\n    const internalEmail = EmailService.generateEmailAddress({\n      first_name: user.first_name,\n      last_name: user.last_name,\n      domain_type: \"internal\",\n    });\n\n    const displayName = EmailService.generateDisplayName(\n      user.first_name,\n      user.last_name,\n      user.role,\n    );\n\n    return {\n      external: externalEmail,\n      internal: internalEmail,\n      display_name: displayName,\n    };\n  }\n\n  // =====================================================\n  // VALIDIERUNG\n  // =====================================================\n\n  /**\n   * Validiert Domain-Strategie E-Mail-Adressen\n   */\n  static validateDomainStrategy(user: DomainUser): {\n    external_valid: boolean;\n    internal_valid: boolean;\n    emails: {\n      external: string;\n      internal: string;\n    };\n  } {\n    const emails = this.generateUserEmails(user);\n\n    const externalValid = EmailService.validateEmailDomain(emails.external, \"external\");\n    const internalValid = EmailService.validateEmailDomain(emails.internal, \"internal\");\n\n    return {\n      external_valid: externalValid,\n      internal_valid: internalValid,\n      emails: {\n        external: emails.external,\n        internal: emails.internal,\n      },\n    };\n  }\n\n  // =====================================================\n  // DEMO-DATEN\n  // =====================================================\n\n  /**\n   * Erstellt Demo-Benutzer f√ºr Domain-Strategie\n   */\n  static createDemoUsers(): DomainUser[] {\n    return [\n      this.createChefUser(),\n      this.createSohnUser(),\n      {\n        first_name: \"Max\",\n        last_name: \"Mustermann\",\n        role: \"Support\",\n        domain_type: \"internal\",\n      },\n      {\n        first_name: \"Anna\",\n        last_name: \"Schmidt\",\n        role: \"Sales\",\n        domain_type: \"internal\",\n      },\n    ];\n  }\n\n  // =====================================================\n  // SQL-INSERT GENERIERUNG\n  // =====================================================\n\n  /**\n   * Generiert SQL-Insert f√ºr Chef-Benutzer\n   * Gesetzliche Namenskonvention: ramiro.lopezrodriguez\n   */\n  static generateChefUserSQL(): string {\n    const chef = this.createChefUser();\n    const emails = this.generateUserEmails(chef);\n\n    return `\nINSERT INTO lopez_users (\n    username, email, email_external, email_internal, password_hash,\n    first_name, last_name, display_name, domain_type, status\n) VALUES (\n    'ramiro.lopezrodriguez',\n    '${emails.external}',\n    '${emails.external}',\n    '${emails.internal}',\n    '$2b$12$hashed_password_here', -- In Produktion: echtes Hash\n    '${chef.first_name}',\n    '${chef.last_name}',\n    '${emails.display_name}',\n    '${chef.domain_type}',\n    'active'\n);`;\n  }\n\n  /**\n   * Generiert SQL-Insert f√ºr Sohn-Benutzer\n   * Gesetzliche Namenskonvention: ramiro.lopezmclean\n   */\n  static generateSohnUserSQL(): string {\n    const sohn = this.createSohnUser();\n    const emails = this.generateUserEmails(sohn);\n\n    return `\nINSERT INTO lopez_users (\n    username, email, email_external, email_internal, password_hash,\n    first_name, last_name, display_name, domain_type, status\n) VALUES (\n    'ramiro.lopezmclean',\n    '${emails.external}',\n    '${emails.external}',\n    '${emails.internal}',\n    '$2b$12$hashed_password_here', -- In Produktion: echtes Hash\n    '${sohn.first_name}',\n    '${sohn.last_name}',\n    '${emails.display_name}',\n    '${sohn.domain_type}',\n    'active'\n);`;\n  }\n}\n"],"names":[],"mappings":"AAAA,wDAAwD;AACxD,kCAAkC;AAClC,wDAAwD;AACxD,uBAAuB;AACvB,0EAA0E;AAC1E,sCAAsC;AACtC,wDAAwD;;;;;AAExD;;AAiBO,MAAM;IACX,wDAAwD;IACxD,0BAA0B;IAC1B,wDAAwD;IAExD;;GAEC,GACD,OAAO,iBAA6B;QAClC,OAAO;YACL,YAAY;YACZ,WAAW;YACX,MAAM;YACN,aAAa;QACf;IACF;IAEA;;GAEC,GACD,OAAO,iBAA6B;QAClC,OAAO;YACL,YAAY;YACZ,WAAW;YACX,MAAM;YACN,aAAa;QACf;IACF;IAEA,wDAAwD;IACxD,qBAAqB;IACrB,wDAAwD;IAExD;;;GAGC,GACD,OAAO,mBAAmB,IAAgB,EAIxC;QACA,MAAM,gBAAgB,gJAAY,CAAC,oBAAoB,CAAC;YACtD,YAAY,KAAK,UAAU;YAC3B,WAAW,KAAK,SAAS;YACzB,aAAa;QACf;QAEA,MAAM,gBAAgB,gJAAY,CAAC,oBAAoB,CAAC;YACtD,YAAY,KAAK,UAAU;YAC3B,WAAW,KAAK,SAAS;YACzB,aAAa;QACf;QAEA,MAAM,cAAc,gJAAY,CAAC,mBAAmB,CAClD,KAAK,UAAU,EACf,KAAK,SAAS,EACd,KAAK,IAAI;QAGX,OAAO;YACL,UAAU;YACV,UAAU;YACV,cAAc;QAChB;IACF;IAEA,wDAAwD;IACxD,cAAc;IACd,wDAAwD;IAExD;;GAEC,GACD,OAAO,uBAAuB,IAAgB,EAO5C;QACA,MAAM,SAAS,IAAI,CAAC,kBAAkB,CAAC;QAEvC,MAAM,gBAAgB,gJAAY,CAAC,mBAAmB,CAAC,OAAO,QAAQ,EAAE;QACxE,MAAM,gBAAgB,gJAAY,CAAC,mBAAmB,CAAC,OAAO,QAAQ,EAAE;QAExE,OAAO;YACL,gBAAgB;YAChB,gBAAgB;YAChB,QAAQ;gBACN,UAAU,OAAO,QAAQ;gBACzB,UAAU,OAAO,QAAQ;YAC3B;QACF;IACF;IAEA,wDAAwD;IACxD,aAAa;IACb,wDAAwD;IAExD;;GAEC,GACD,OAAO,kBAAgC;QACrC,OAAO;YACL,IAAI,CAAC,cAAc;YACnB,IAAI,CAAC,cAAc;YACnB;gBACE,YAAY;gBACZ,WAAW;gBACX,MAAM;gBACN,aAAa;YACf;YACA;gBACE,YAAY;gBACZ,WAAW;gBACX,MAAM;gBACN,aAAa;YACf;SACD;IACH;IAEA,wDAAwD;IACxD,yBAAyB;IACzB,wDAAwD;IAExD;;;GAGC,GACD,OAAO,sBAA8B;QACnC,MAAM,OAAO,IAAI,CAAC,cAAc;QAChC,MAAM,SAAS,IAAI,CAAC,kBAAkB,CAAC;QAEvC,OAAO,CAAC;;;;;;KAMP,EAAE,OAAO,QAAQ,CAAC;KAClB,EAAE,OAAO,QAAQ,CAAC;KAClB,EAAE,OAAO,QAAQ,CAAC;;KAElB,EAAE,KAAK,UAAU,CAAC;KAClB,EAAE,KAAK,SAAS,CAAC;KACjB,EAAE,OAAO,YAAY,CAAC;KACtB,EAAE,KAAK,WAAW,CAAC;;EAEtB,CAAC;IACD;IAEA;;;GAGC,GACD,OAAO,sBAA8B;QACnC,MAAM,OAAO,IAAI,CAAC,cAAc;QAChC,MAAM,SAAS,IAAI,CAAC,kBAAkB,CAAC;QAEvC,OAAO,CAAC;;;;;;KAMP,EAAE,OAAO,QAAQ,CAAC;KAClB,EAAE,OAAO,QAAQ,CAAC;KAClB,EAAE,OAAO,QAAQ,CAAC;;KAElB,EAAE,KAAK,UAAU,CAAC;KAClB,EAAE,KAAK,SAAS,CAAC;KACjB,EAAE,OAAO,YAAY,CAAC;KACtB,EAAE,KAAK,WAAW,CAAC;;EAEtB,CAAC;IACD;AACF","debugId":null}},
    {"offset": {"line": 1521, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/lib/uuid-service.ts"],"sourcesContent":["// =====================================================\n// UUID SERVICE - LOPEZ IT WELT\n// =====================================================\n// Erstellt: 2025-09-20\n// Zweck: UUID v4/v7 Generation f√ºr Enterprise++ Sicherheit\n// Status: ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT\n// =====================================================\n\n// Edge Runtime compatible UUID generation\n// import { randomBytes, randomUUID } from 'crypto';\n\n// =====================================================\n// INTERFACES\n// =====================================================\n\nexport interface UUIDConfig {\n  version: \"v4\" | \"v7\";\n  secure: boolean;\n}\n\n// =====================================================\n// UUID SERVICE CLASS\n// =====================================================\n\nexport class UUIDService {\n  // =====================================================\n  // UUID GENERATION\n  // =====================================================\n\n  /**\n   * Generiert UUID v4 (Standard)\n   * Nicht erratbar, sicher, weltweit Standard\n   */\n  static generateV4(): string {\n    // Edge Runtime compatible UUID v4 generation\n    return \"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\".replace(/[xy]/g, function (c) {\n      const r = (Math.random() * 16) | 0;\n      const v = c === \"x\" ? r : (r & 0x3) | 0x8;\n      return v.toString(16);\n    });\n  }\n\n  /**\n   * Generiert UUID v7 (Zeitstempel-basiert)\n   * Sortierbar, zeitlich geordnet\n   */\n  static generateV7(): string {\n    // UUID v7 Implementation - Edge Runtime compatible\n    const timestamp = Date.now();\n    const random = new Uint8Array(10);\n    crypto.getRandomValues(random);\n\n    // Timestamp (48 bits)\n    const timeHigh = (timestamp >>> 16) & 0xffff;\n    const timeLow = timestamp & 0xffff;\n\n    // Random data (74 bits)\n    const random1 = random.readUInt16BE(0) & 0x0fff; // 12 bits\n    const random2 = random.readUInt16BE(2) & 0x3fff; // 14 bits\n    const random3 = random.readUInt16BE(4) & 0x3fff; // 14 bits\n    const random4 = random.readUInt16BE(6) & 0x3fff; // 14 bits\n    const random5 = random.readUInt16BE(8) & 0x3fff; // 14 bits\n\n    // Version 7 (0111)\n    const version = 0x7000;\n\n    // Variant (10)\n    const variant = 0x8000;\n\n    // UUID v7 Format: xxxxxxxx-xxxx-7xxx-xxxx-xxxxxxxxxxxx\n    const uuid = [\n      timeHigh.toString(16).padStart(4, \"0\"),\n      timeLow.toString(16).padStart(4, \"0\"),\n      \"-\",\n      (random1 | version).toString(16).padStart(4, \"0\"),\n      \"-\",\n      (random2 | variant).toString(16).padStart(4, \"0\"),\n      \"-\",\n      random3.toString(16).padStart(4, \"0\"),\n      \"-\",\n      random4.toString(16).padStart(4, \"0\"),\n      random5.toString(16).padStart(4, \"0\"),\n    ].join(\"\");\n\n    return uuid;\n  }\n\n  /**\n   * Generiert sichere UUID basierend auf Konfiguration\n   */\n  static generate(config: UUIDConfig = { version: \"v4\", secure: true }): string {\n    if (config.version === \"v7\") {\n      return this.generateV7();\n    }\n    return this.generateV4();\n  }\n\n  // =====================================================\n  // VALIDATION\n  // =====================================================\n\n  /**\n   * Validiert UUID Format\n   */\n  static isValid(uuid: string): boolean {\n    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n    return uuidRegex.test(uuid);\n  }\n\n  /**\n   * Validiert UUID v4\n   */\n  static isV4(uuid: string): boolean {\n    if (!this.isValid(uuid)) return false;\n    return uuid[14] === \"4\";\n  }\n\n  /**\n   * Validiert UUID v7\n   */\n  static isV7(uuid: string): boolean {\n    if (!this.isValid(uuid)) return false;\n    return uuid[14] === \"7\";\n  }\n\n  // =====================================================\n  // ENTERPRISE++ FEATURES\n  // =====================================================\n\n  /**\n   * Generiert Owner UUID (spezielle Kennzeichnung)\n   */\n  static generateOwnerUUID(): string {\n    const uuid = this.generateV4();\n    // Owner UUIDs haben spezielle Kennzeichnung\n    return `owner_${uuid}`;\n  }\n\n  /**\n   * Generiert Admin UUID\n   */\n  static generateAdminUUID(): string {\n    return this.generateV4();\n  }\n\n  /**\n   * Generiert Customer UUID\n   */\n  static generateCustomerUUID(): string {\n    return this.generateV4();\n  }\n\n  /**\n   * Generiert Session UUID\n   */\n  static generateSessionUUID(): string {\n    return this.generateV4();\n  }\n\n  // =====================================================\n  // SECURITY FEATURES\n  // =====================================================\n\n  /**\n   * Generiert sichere Random String\n   */\n  static generateSecureRandom(length: number = 32): string {\n    return randomBytes(length).toString(\"hex\");\n  }\n\n  /**\n   * Generiert Salt f√ºr Passwort-Hashing\n   */\n  static generateSalt(): string {\n    return randomBytes(16).toString(\"hex\");\n  }\n\n  /**\n   * Generiert Pepper f√ºr Passwort-Hashing\n   */\n  static generatePepper(): string {\n    return randomBytes(16).toString(\"hex\");\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1669, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/lib/argon2-service.ts"],"sourcesContent":["// =====================================================\n// ARGON2ID SERVICE - LOPEZ IT WELT\n// =====================================================\n// Erstellt: 2025-09-20\n// Zweck: Argon2id Passwort-Hashing f√ºr Enterprise++ Sicherheit\n// Status: ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT\n// =====================================================\n\nimport argon2 from \"argon2\";\nimport { UUIDService } from \"./uuid-service\";\n\n// =====================================================\n// INTERFACES\n// =====================================================\n\nexport interface Argon2Config {\n  type: argon2.argon2id;\n  memoryCost: number;\n  timeCost: number;\n  parallelism: number;\n  hashLength: number;\n}\n\nexport interface HashResult {\n  hash: string;\n  salt: string;\n  pepper: string;\n  config: Argon2Config;\n}\n\n// =====================================================\n// ARGON2 SERVICE CLASS\n// =====================================================\n\nexport class Argon2Service {\n  // =====================================================\n  // KONFIGURATION\n  // =====================================================\n\n  /**\n   * Enterprise++ Argon2id Konfiguration\n   * DSGVO/ISO27001-konform\n   */\n  static readonly CONFIG: Argon2Config = {\n    type: argon2.argon2id,\n    memoryCost: 65536, // 64 MB\n    timeCost: 3, // 3 Iterationen\n    parallelism: 4, // 4 Threads\n    hashLength: 32, // 32 Bytes\n  };\n\n  /**\n   * Pepper f√ºr zus√§tzliche Sicherheit\n   * Sollte in .env gespeichert werden\n   */\n  static readonly PEPPER = process.env.ARGON2_PEPPER || \"default-pepper-change-in-production\";\n\n  // =====================================================\n  // PASSWORD HASHING\n  // =====================================================\n\n  /**\n   * Hasht Passwort mit Argon2id + Salt + Pepper\n   */\n  static async hashPassword(password: string): Promise<HashResult> {\n    try {\n      // Salt generieren\n      const salt = UUIDService.generateSalt();\n\n      // Pepper hinzuf√ºgen\n      const passwordWithPepper = password + this.PEPPER;\n\n      // Argon2id Hash generieren\n      const hash = await argon2.hash(passwordWithPepper, {\n        type: this.CONFIG.type,\n        memoryCost: this.CONFIG.memoryCost,\n        timeCost: this.CONFIG.timeCost,\n        parallelism: this.CONFIG.parallelism,\n        hashLength: this.CONFIG.hashLength,\n        salt: Buffer.from(salt, \"hex\"),\n      });\n\n      return {\n        hash,\n        salt,\n        pepper: this.PEPPER,\n        config: this.CONFIG,\n      };\n    } catch (error) {\n      console.error(\"Argon2 Hash Fehler:\", error);\n      throw new Error(\"Passwort-Hashing fehlgeschlagen\");\n    }\n  }\n\n  /**\n   * Verifiziert Passwort gegen Hash\n   */\n  static async verifyPassword(password: string, hash: string, salt: string): Promise<boolean> {\n    try {\n      // Pepper hinzuf√ºgen\n      const passwordWithPepper = password + this.PEPPER;\n\n      // Hash verifizieren\n      return await argon2.verify(hash, passwordWithPepper);\n    } catch (error) {\n      console.error(\"Argon2 Verify Fehler:\", error);\n      return false;\n    }\n  }\n\n  // =====================================================\n  // PASSWORD STRENGTH\n  // =====================================================\n\n  /**\n   * Pr√ºft Passwort-St√§rke (Enterprise++ Standard)\n   */\n  static validatePasswordStrength(password: string): {\n    isValid: boolean;\n    score: number;\n    level: \"weak\" | \"okay\" | \"strong\" | \"very_strong\";\n    requirements: {\n      minLength: boolean;\n      hasUppercase: boolean;\n      hasLowercase: boolean;\n      hasNumbers: boolean;\n      hasSpecialChars: boolean;\n    };\n  } {\n    const requirements = {\n      minLength: password.length >= 12,\n      hasUppercase: /[A-Z]/.test(password),\n      hasLowercase: /[a-z]/.test(password),\n      hasNumbers: /\\d/.test(password),\n      hasSpecialChars: /[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password),\n    };\n\n    const score = Object.values(requirements).filter(Boolean).length;\n\n    let level: \"weak\" | \"okay\" | \"strong\" | \"very_strong\";\n    if (score < 3) level = \"weak\";\n    else if (score < 4) level = \"okay\";\n    else if (score < 5) level = \"strong\";\n    else level = \"very_strong\";\n\n    return {\n      isValid: requirements.minLength && score >= 4,\n      score,\n      level,\n      requirements,\n    };\n  }\n\n  // =====================================================\n  // SECURITY FEATURES\n  // =====================================================\n\n  /**\n   * Generiert sicheres tempor√§res Passwort\n   */\n  static generateSecurePassword(length: number = 16): string {\n    const charset = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*\";\n    let password = \"\";\n\n    for (let i = 0; i < length; i++) {\n      password += charset.charAt(Math.floor(Math.random() * charset.length));\n    }\n\n    return password;\n  }\n\n  /**\n   * Pr√ºft ob Passwort in der Historie ist\n   */\n  static async isPasswordInHistory(password: string, history: string[]): Promise<boolean> {\n    for (const oldHash of history) {\n      if (await this.verifyPassword(password, oldHash, \"\")) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  // =====================================================\n  // AUDIT & COMPLIANCE\n  // =====================================================\n\n  /**\n   * Erstellt Audit-Log f√ºr Passwort-√Ñnderung\n   */\n  static createPasswordChangeAudit(userId: string, action: \"created\" | \"changed\" | \"reset\"): any {\n    return {\n      user_id: userId,\n      action: `password_${action}`,\n      severity: \"medium\",\n      compliance_category: \"security\",\n      timestamp: new Date().toISOString(),\n      details: {\n        hashing_algorithm: \"argon2id\",\n        memory_cost: this.CONFIG.memoryCost,\n        time_cost: this.CONFIG.timeCost,\n        parallelism: this.CONFIG.parallelism,\n      },\n    };\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1820, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/lib/enterprise-user-service.ts"],"sourcesContent":["// =====================================================\n// ENTERPRISE++ USER SERVICE - LOPEZ IT WELT\n// =====================================================\n// Erstellt: 2025-09-20\n// Zweck: Enterprise++ Benutzer-Management mit UUID & Argon2id\n// Status: ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT\n// =====================================================\n\nimport { Argon2Service } from \"./argon2-service\";\nimport { getConnection } from \"./database\";\nimport { UUIDService } from \"./uuid-service\";\n\n// =====================================================\n// INTERFACES\n// =====================================================\n\nexport interface EnterpriseUser {\n  id: string;\n  username: string;\n  email: string;\n  email_external?: string;\n  email_internal?: string;\n  first_name: string;\n  last_name: string;\n  display_name?: string;\n  password_hash: string;\n  salt: string;\n  pepper: string;\n  is_owner: boolean;\n  is_admin: boolean;\n  is_employee: boolean;\n  is_customer: boolean;\n  two_factor_enabled: boolean;\n  two_factor_secret?: string;\n  backup_codes?: string[];\n  status: \"active\" | \"inactive\" | \"locked\" | \"pending\" | \"suspended\";\n  role: string;\n  permissions?: string[];\n  domain_type: \"external\" | \"internal\";\n  last_login?: string;\n  password_changed_at?: string;\n  failed_login_attempts: number;\n  locked_until?: string;\n  created_at: string;\n  updated_at: string;\n}\n\nexport interface CreateUserData {\n  username: string;\n  email: string;\n  email_external?: string;\n  email_internal?: string;\n  first_name: string;\n  last_name: string;\n  display_name?: string;\n  password: string;\n  is_owner?: boolean;\n  is_admin?: boolean;\n  is_employee?: boolean;\n  is_customer?: boolean;\n  role?: string;\n  permissions?: string[];\n  domain_type?: \"external\" | \"internal\";\n}\n\nexport interface UpdateUserData {\n  first_name?: string;\n  last_name?: string;\n  display_name?: string;\n  email?: string;\n  email_external?: string;\n  email_internal?: string;\n  status?: \"active\" | \"inactive\" | \"locked\" | \"pending\" | \"suspended\";\n  role?: string;\n  permissions?: string[];\n  domain_type?: \"external\" | \"internal\";\n}\n\n// =====================================================\n// ENTERPRISE USER SERVICE CLASS\n// =====================================================\n\nexport class EnterpriseUserService {\n  // =====================================================\n  // USER CREATION\n  // =====================================================\n\n  /**\n   * Erstellt neuen Enterprise++ Benutzer\n   */\n  static async createUser(userData: CreateUserData): Promise<EnterpriseUser> {\n    try {\n      const connection = await getConnection();\n\n      // UUID generieren\n      const userId = UUIDService.generateV4();\n\n      // Passwort hashen\n      const hashResult = await Argon2Service.hashPassword(userData.password);\n\n      // Display Name generieren\n      const displayName =\n        userData.display_name ||\n        `${userData.first_name} ${userData.last_name}${userData.role ? ` - ${userData.role}` : \"\"}`;\n\n      // SQL Insert\n      const [result] = await connection.execute(\n        `\n                INSERT INTO lopez_enterprise_users (\n                    id, username, email, email_external, email_internal,\n                    first_name, last_name, display_name, password_hash, salt, pepper,\n                    is_owner, is_admin, is_employee, is_customer, role, permissions,\n                    domain_type, status, password_changed_at\n                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())\n            `,\n        [\n          userId,\n          userData.username,\n          userData.email,\n          userData.email_external || null,\n          userData.email_internal || null,\n          userData.first_name,\n          userData.last_name,\n          displayName,\n          hashResult.hash,\n          hashResult.salt,\n          hashResult.pepper,\n          userData.is_owner || false,\n          userData.is_admin || false,\n          userData.is_employee || false,\n          userData.is_customer || false,\n          userData.role || \"user\",\n          JSON.stringify(userData.permissions || []),\n          userData.domain_type || \"internal\",\n          \"pending\",\n        ],\n      );\n\n      // Passwort-Historie speichern\n      await this.addPasswordToHistory(userId, hashResult.hash, hashResult.salt);\n\n      // Benutzer laden und zur√ºckgeben\n      const user = await this.getUserById(userId);\n      if (!user) {\n        throw new Error(\"Benutzer konnte nicht erstellt werden\");\n      }\n\n      return user;\n    } catch (error) {\n      console.error(\"Enterprise User Creation Fehler:\", error);\n      throw new Error(\"Benutzer konnte nicht erstellt werden\");\n    }\n  }\n\n  /**\n   * Erstellt Owner-Benutzer (Chef)\n   */\n  static async createOwnerUser(userData: CreateUserData): Promise<EnterpriseUser> {\n    const ownerData = {\n      ...userData,\n      is_owner: true,\n      is_admin: true,\n      role: \"Owner\",\n      permissions: [\"*\"],\n      domain_type: \"external\" as const,\n    };\n\n    return await this.createUser(ownerData);\n  }\n\n  /**\n   * Erstellt Admin-Benutzer\n   */\n  static async createAdminUser(userData: CreateUserData): Promise<EnterpriseUser> {\n    const adminData = {\n      ...userData,\n      is_admin: true,\n      role: \"Admin\",\n      permissions: [\"admin.*\", \"user.*\", \"customer.*\"],\n      domain_type: \"external\" as const,\n    };\n\n    return await this.createUser(adminData);\n  }\n\n  /**\n   * Erstellt Employee-Benutzer\n   */\n  static async createEmployeeUser(userData: CreateUserData): Promise<EnterpriseUser> {\n    const employeeData = {\n      ...userData,\n      is_employee: true,\n      role: \"Employee\",\n      permissions: [\"customer.read\", \"customer.update\"],\n      domain_type: \"internal\" as const,\n    };\n\n    return await this.createUser(employeeData);\n  }\n\n  /**\n   * Erstellt Customer-Benutzer\n   */\n  static async createCustomerUser(userData: CreateUserData): Promise<EnterpriseUser> {\n    const customerData = {\n      ...userData,\n      is_customer: true,\n      role: \"Customer\",\n      permissions: [\"profile.read\", \"profile.update\"],\n      domain_type: \"external\" as const,\n    };\n\n    return await this.createUser(customerData);\n  }\n\n  // =====================================================\n  // USER RETRIEVAL\n  // =====================================================\n\n  /**\n   * L√§dt Benutzer nach ID\n   */\n  static async getUserById(id: string): Promise<EnterpriseUser | null> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\n        `\n                SELECT * FROM lopez_enterprise_users WHERE id = ?\n            `,\n        [id],\n      );\n\n      const users = rows as EnterpriseUser[];\n      return users[0] || null;\n    } catch (error) {\n      console.error(\"Get User by ID Fehler:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * L√§dt Benutzer nach Username\n   */\n  static async getUserByUsername(username: string): Promise<EnterpriseUser | null> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\n        `\n                SELECT * FROM lopez_enterprise_users WHERE username = ?\n            `,\n        [username],\n      );\n\n      const users = rows as EnterpriseUser[];\n      return users[0] || null;\n    } catch (error) {\n      console.error(\"Get User by Username Fehler:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * L√§dt Chef-Benutzer (Development Mode)\n   */\n  static async getChefUser(): Promise<EnterpriseUser | null> {\n    return await this.getUserByUsername(\"ramiro.lopezrodriguez\");\n  }\n\n  /**\n   * L√§dt alle Admin-Benutzer\n   */\n  static async getAdminUsers(): Promise<EnterpriseUser[]> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\n        `\n                SELECT * FROM lopez_enterprise_users \n                WHERE is_admin = true OR is_owner = true\n                ORDER BY created_at DESC\n            `,\n      );\n\n      return rows as EnterpriseUser[];\n    } catch (error) {\n      console.error(\"Get Admin Users Fehler:\", error);\n      return [];\n    }\n  }\n\n  /**\n   * L√§dt Benutzer nach Email\n   */\n  static async getUserByEmail(email: string): Promise<EnterpriseUser | null> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\n        `\n                SELECT * FROM lopez_enterprise_users WHERE email = ? OR email_external = ? OR email_internal = ?\n            `,\n        [email, email, email],\n      );\n\n      const users = rows as EnterpriseUser[];\n      return users[0] || null;\n    } catch (error) {\n      console.error(\"Get User by Email Fehler:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * L√§dt alle Benutzer\n   */\n  static async getAllUsers(): Promise<EnterpriseUser[]> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(`\n                SELECT * FROM lopez_enterprise_users ORDER BY created_at DESC\n            `);\n\n      return rows as EnterpriseUser[];\n    } catch (error) {\n      console.error(\"Get All Users Fehler:\", error);\n      return [];\n    }\n  }\n\n  // =====================================================\n  // USER UPDATES\n  // =====================================================\n\n  /**\n   * Aktualisiert Benutzer\n   */\n  static async updateUser(id: string, userData: UpdateUserData): Promise<boolean> {\n    try {\n      const connection = await getConnection();\n\n      // Update-Felder dynamisch erstellen\n      const updateFields = [];\n      const values = [];\n\n      if (userData.first_name) {\n        updateFields.push(\"first_name = ?\");\n        values.push(userData.first_name);\n      }\n      if (userData.last_name) {\n        updateFields.push(\"last_name = ?\");\n        values.push(userData.last_name);\n      }\n      if (userData.display_name) {\n        updateFields.push(\"display_name = ?\");\n        values.push(userData.display_name);\n      }\n      if (userData.email) {\n        updateFields.push(\"email = ?\");\n        values.push(userData.email);\n      }\n      if (userData.email_external) {\n        updateFields.push(\"email_external = ?\");\n        values.push(userData.email_external);\n      }\n      if (userData.email_internal) {\n        updateFields.push(\"email_internal = ?\");\n        values.push(userData.email_internal);\n      }\n      if (userData.status) {\n        updateFields.push(\"status = ?\");\n        values.push(userData.status);\n      }\n      if (userData.role) {\n        updateFields.push(\"role = ?\");\n        values.push(userData.role);\n      }\n      if (userData.permissions) {\n        updateFields.push(\"permissions = ?\");\n        values.push(JSON.stringify(userData.permissions));\n      }\n      if (userData.domain_type) {\n        updateFields.push(\"domain_type = ?\");\n        values.push(userData.domain_type);\n      }\n\n      if (updateFields.length === 0) {\n        return false;\n      }\n\n      updateFields.push(\"updated_at = NOW()\");\n      values.push(id);\n\n      await connection.execute(\n        `\n                UPDATE lopez_enterprise_users \n                SET ${updateFields.join(\", \")} \n                WHERE id = ?\n            `,\n        values,\n      );\n\n      return true;\n    } catch (error) {\n      console.error(\"Update User Fehler:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * √Ñndert Passwort\n   */\n  static async changePassword(id: string, newPassword: string): Promise<boolean> {\n    try {\n      const connection = await getConnection();\n\n      // Passwort hashen\n      const hashResult = await Argon2Service.hashPassword(newPassword);\n\n      // Passwort aktualisieren\n      await connection.execute(\n        `\n                UPDATE lopez_enterprise_users \n                SET password_hash = ?, salt = ?, pepper = ?, password_changed_at = NOW() \n                WHERE id = ?\n            `,\n        [hashResult.hash, hashResult.salt, hashResult.pepper, id],\n      );\n\n      // Passwort-Historie speichern\n      await this.addPasswordToHistory(id, hashResult.hash, hashResult.salt);\n\n      return true;\n    } catch (error) {\n      console.error(\"Change Password Fehler:\", error);\n      return false;\n    }\n  }\n\n  // =====================================================\n  // PASSWORD HISTORY\n  // =====================================================\n\n  /**\n   * F√ºgt Passwort zur Historie hinzu\n   */\n  static async addPasswordToHistory(\n    userId: string,\n    passwordHash: string,\n    salt: string,\n  ): Promise<void> {\n    try {\n      const connection = await getConnection();\n\n      await connection.execute(\n        `\n                INSERT INTO lopez_password_history (user_id, password_hash, salt) \n                VALUES (?, ?, ?)\n            `,\n        [userId, passwordHash, salt],\n      );\n\n      // Alte Passw√∂rter l√∂schen (nur die letzten 5 behalten)\n      await connection.execute(\n        `\n                DELETE FROM lopez_password_history \n                WHERE user_id = ? AND id NOT IN (\n                    SELECT id FROM (\n                        SELECT id FROM lopez_password_history \n                        WHERE user_id = ? \n                        ORDER BY created_at DESC \n                        LIMIT 5\n                    ) AS recent_passwords\n                )\n            `,\n        [userId, userId],\n      );\n    } catch (error) {\n      console.error(\"Add Password to History Fehler:\", error);\n    }\n  }\n\n  /**\n   * Pr√ºft ob Passwort in der Historie ist\n   */\n  static async isPasswordInHistory(userId: string, password: string): Promise<boolean> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\n        `\n                SELECT password_hash, salt FROM lopez_password_history \n                WHERE user_id = ? \n                ORDER BY created_at DESC\n            `,\n        [userId],\n      );\n\n      const history = rows as { password_hash: string; salt: string }[];\n\n      for (const entry of history) {\n        if (await Argon2Service.verifyPassword(password, entry.password_hash, entry.salt)) {\n          return true;\n        }\n      }\n\n      return false;\n    } catch (error) {\n      console.error(\"Check Password History Fehler:\", error);\n      return false;\n    }\n  }\n\n  // =====================================================\n  // AUTHENTICATION\n  // =====================================================\n\n  /**\n   * Verifiziert Benutzer-Login\n   */\n  static async verifyLogin(username: string, password: string): Promise<EnterpriseUser | null> {\n    try {\n      // Benutzer laden\n      let user = await this.getUserByUsername(username);\n      if (!user) {\n        user = await this.getUserByEmail(username);\n      }\n\n      if (!user) {\n        return null;\n      }\n\n      // Passwort verifizieren\n      const isValid = await Argon2Service.verifyPassword(password, user.password_hash, user.salt);\n      if (!isValid) {\n        return null;\n      }\n\n      // Status pr√ºfen\n      if (user.status !== \"active\") {\n        return null;\n      }\n\n      // Account gesperrt?\n      if (user.locked_until && new Date(user.locked_until) > new Date()) {\n        return null;\n      }\n\n      return user;\n    } catch (error) {\n      console.error(\"Verify Login Fehler:\", error);\n      return null;\n    }\n  }\n\n  // =====================================================\n  // SECURITY FEATURES\n  // =====================================================\n\n  /**\n   * Sperrt Benutzer-Account\n   */\n  static async lockUser(id: string, durationMinutes: number = 30): Promise<boolean> {\n    try {\n      const connection = await getConnection();\n      const lockedUntil = new Date();\n      lockedUntil.setMinutes(lockedUntil.getMinutes() + durationMinutes);\n\n      await connection.execute(\n        `\n                UPDATE lopez_enterprise_users \n                SET locked_until = ?, status = 'locked' \n                WHERE id = ?\n            `,\n        [lockedUntil, id],\n      );\n\n      return true;\n    } catch (error) {\n      console.error(\"Lock User Fehler:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Entsperrt Benutzer-Account\n   */\n  static async unlockUser(id: string): Promise<boolean> {\n    try {\n      const connection = await getConnection();\n\n      await connection.execute(\n        `\n                UPDATE lopez_enterprise_users \n                SET locked_until = NULL, failed_login_attempts = 0, status = 'active' \n                WHERE id = ?\n            `,\n        [id],\n      );\n\n      return true;\n    } catch (error) {\n      console.error(\"Unlock User Fehler:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Erh√∂ht fehlgeschlagene Login-Versuche\n   */\n  static async incrementFailedLogins(id: string): Promise<void> {\n    try {\n      const connection = await getConnection();\n\n      await connection.execute(\n        `\n                UPDATE lopez_enterprise_users \n                SET failed_login_attempts = failed_login_attempts + 1 \n                WHERE id = ?\n            `,\n        [id],\n      );\n\n      // Nach 5 Versuchen sperren\n      const [rows] = await connection.execute(\n        `\n                SELECT failed_login_attempts FROM lopez_enterprise_users WHERE id = ?\n            `,\n        [id],\n      );\n\n      const user = (rows as any[])[0];\n      if (user && user.failed_login_attempts >= 5) {\n        await this.lockUser(id, 30);\n      }\n    } catch (error) {\n      console.error(\"Increment Failed Logins Fehler:\", error);\n    }\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2305, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/lib/development-mode.ts"],"sourcesContent":["// =====================================================\n// DEVELOPMENT MODE - LOPEZ IT WELT\n// =====================================================\n// Erstellt: 2025-09-20\n// Zweck: Login optional f√ºr lokale Entwicklung\n// Status: ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT\n// =====================================================\n\nimport { DomainStrategy } from \"./domain-strategy\";\nimport { EnterpriseUserService } from \"./enterprise-user-service\";\n\n// =====================================================\n// INTERFACES\n// =====================================================\n\nexport interface DevelopmentModeConfig {\n  enabled: boolean;\n  bypassAuth: boolean;\n  defaultUser: {\n    id: number;\n    username: string;\n    email: string;\n    first_name: string;\n    last_name: string;\n    role: string;\n  };\n}\n\n// =====================================================\n// DEVELOPMENT MODE CLASS\n// =====================================================\n\nexport class DevelopmentMode {\n  // =====================================================\n  // KONFIGURATION\n  // =====================================================\n\n  /**\n   * Pr√ºft ob Development Mode aktiviert ist\n   */\n  static isEnabled(): boolean {\n    return process.env.NODE_ENV === \"development\" && process.env.DEVELOPMENT_MODE === \"true\";\n  }\n\n  /**\n   * Pr√ºft ob Authentication umgangen werden soll\n   */\n  static shouldBypassAuth(): boolean {\n    return this.isEnabled() && process.env.BYPASS_AUTH === \"true\";\n  }\n\n  /**\n   * Gibt Development Mode Konfiguration zur√ºck\n   */\n  static getConfig(): DevelopmentModeConfig {\n    return {\n      enabled: this.isEnabled(),\n      bypassAuth: this.shouldBypassAuth(),\n      defaultUser: {\n        id: 1,\n        username: \"ramiro.lopezrodriguez\",\n        email: \"ramiro.lopezrodriguez@lopezitwelt.de\",\n        first_name: \"Ramiro\",\n        last_name: \"Lopez Rodriguez\",\n        role: \"Chef\",\n      },\n    };\n  }\n\n  // =====================================================\n  // AUTHENTICATION BYPASS\n  // =====================================================\n\n  /**\n   * Erstellt Mock-User f√ºr Development Mode\n   */\n  static createMockUser(): Record<string, unknown> | null {\n    if (!this.shouldBypassAuth()) {\n      return null;\n    }\n\n    return {\n      id: \"dev-chef-uuid-001\",\n      username: \"ramiro.lopezrodriguez\",\n      email: \"ramiro.lopezrodriguez@lopezitwelt.de\",\n      email_external: \"ramiro.lopezrodriguez@lopezitwelt.de\",\n      email_internal: \"ramiro.lopezrodriguez@lopez-team.de\",\n      first_name: \"Ramiro\",\n      last_name: \"Lopez Rodriguez\",\n      display_name: \"Ramiro Lopez Rodriguez - Chef\",\n      domain_type: \"external\",\n      status: \"active\",\n      is_owner: true,\n      is_admin: true,\n      is_employee: true,\n      is_customer: false,\n      role: \"Chef\",\n      roles: [\"chef\", \"admin\", \"owner\"],\n      permissions: [\"*\"], // Alle Rechte\n      two_factor_enabled: false,\n      failed_login_attempts: 0,\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n    };\n  }\n\n  /**\n   * Pr√ºft ob Route im Development Mode umgangen werden soll\n   */\n  static shouldBypassRoute(route: string): boolean {\n    if (!this.shouldBypassAuth()) {\n      return false;\n    }\n\n    // Routen die im Development Mode umgangen werden\n    const bypassRoutes = [\"/api/auth/login\", \"/api/auth/logout\", \"/api/admin/*\"];\n\n    return bypassRoutes.some((pattern) => {\n      if (pattern.includes(\"*\")) {\n        return route.startsWith(pattern.replace(\"*\", \"\"));\n      }\n      return route === pattern;\n    });\n  }\n\n  // =====================================================\n  // MIDDLEWARE\n  // =====================================================\n\n  /**\n   * Development Mode Middleware\n   */\n  static middleware(req: Request, res: Response, next: () => void) {\n    if (this.shouldBypassAuth()) {\n      // Mock-User in Request einf√ºgen\n      req.user = this.createMockUser();\n      req.isDevelopmentMode = true;\n\n      // Development Mode: Authentication umgangen\n      // Mock-User: ${req.user.display_name}\n    }\n\n    next();\n  }\n\n  // =====================================================\n  // API RESPONSES\n  // =====================================================\n\n  /**\n   * Erstellt Development Mode Login Response\n   */\n  static createLoginResponse(): any {\n    if (!this.shouldBypassAuth()) {\n      return null;\n    }\n\n    return {\n      success: true,\n      message: \"Development Mode: Login umgangen\",\n      user: this.createMockUser(),\n      token: \"dev-mode-token\",\n      isDevelopmentMode: true,\n    };\n  }\n\n  /**\n   * Erstellt Development Mode Logout Response\n   */\n  static createLogoutResponse(): any {\n    if (!this.shouldBypassAuth()) {\n      return null;\n    }\n\n    return {\n      success: true,\n      message: \"Development Mode: Logout umgangen\",\n      isDevelopmentMode: true,\n    };\n  }\n\n  // =====================================================\n  // CHEF-BENUTZER MANAGEMENT\n  // =====================================================\n\n  /**\n   * Erstellt Chef-Benutzer f√ºr Development Mode\n   */\n  static async createChefUser(): Promise<Record<string, unknown> | null> {\n    if (!this.isEnabled()) {\n      return null;\n    }\n\n    try {\n      const chefData = DomainStrategy.createChefUser();\n      const emails = DomainStrategy.generateUserEmails(chefData);\n\n      const userData = {\n        username: \"ramiro.lopezrodriguez\",\n        email: emails.external,\n        email_external: emails.external,\n        email_internal: emails.internal,\n        first_name: chefData.first_name,\n        last_name: chefData.last_name,\n        display_name: emails.display_name,\n        password: \"DevMode123!\", // Development Password\n        is_owner: true,\n        is_admin: true,\n        is_employee: true,\n        is_customer: false,\n        role: \"Chef\",\n        permissions: [\"*\"],\n        domain_type: \"external\",\n      };\n\n      return await EnterpriseUserService.createUser(userData);\n    } catch (error) {\n      // Fehler beim Erstellen des Chef-Benutzers: ${error}\n      return null;\n    }\n  }\n\n  /**\n   * Pr√ºft ob Chef-Benutzer existiert\n   */\n  static async checkChefUserExists(): Promise<boolean> {\n    try {\n      const user = await EnterpriseUserService.getUserByUsername(\"ramiro.lopezrodriguez\");\n      return user !== null;\n    } catch {\n      return false;\n    }\n  }\n\n  // =====================================================\n  // ENVIRONMENT SETUP\n  // =====================================================\n\n  /**\n   * Setup Development Mode Environment\n   */\n  static async setupEnvironment(): Promise<void> {\n    if (process.env.NODE_ENV === \"development\") {\n      // Development Mode verf√ºgbar\n      // Um zu aktivieren:\n      //   DEVELOPMENT_MODE=true\n      //   BYPASS_AUTH=true\n      //\n      // Beispiel .env.local:\n      //   NODE_ENV=development\n      //   DEVELOPMENT_MODE=true\n      //   BYPASS_AUTH=true\n\n      // Chef-Benutzer pr√ºfen/erstellen\n      if (this.isEnabled()) {\n        const chefExists = await this.checkChefUserExists();\n        if (!chefExists) {\n          // Chef-Benutzer wird erstellt...\n          const chef = await this.createChefUser();\n          if (chef) {\n            // Chef-Benutzer erfolgreich erstellt: ${chef.display_name}\n          } else {\n            // Fehler beim Erstellen des Chef-Benutzers\n          }\n        } else {\n          // Chef-Benutzer bereits vorhanden\n        }\n      }\n    }\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2537, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/lib/rbac-system.ts"],"sourcesContent":["// =====================================================\n// RBAC/ABAC SYSTEM - LOPEZ IT WELT\n// =====================================================\n// Erstellt: 2025-01-19\n// Zweck: Rollen- und berechtigungsbasiertes Zugriffskontrollsystem\n// Status: ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT\n// =====================================================\n\nimport { getConnection } from \"./database\";\n\n// =====================================================\n// INTERFACES\n// =====================================================\n\nexport interface User {\n  id?: number;\n  username: string;\n  email: string;\n  email_external?: string; // lopezitwelt.de f√ºr externe Kommunikation\n  email_internal?: string; // lopez-team.de f√ºr interne Kommunikation\n  password_hash: string;\n  first_name: string;\n  last_name: string;\n  display_name?: string; // \"Ramiro Lopez Rodriguez - Admin\"\n  admin_alias?: string; // \"r.lopez\", \"r.mclean\"\n  domain_type?: \"external\" | \"internal\";\n  status: \"active\" | \"inactive\" | \"locked\" | \"pending\";\n  last_login?: string;\n  created_at?: string;\n  updated_at?: string;\n}\n\nexport interface Role {\n  id?: number;\n  name: string;\n  description: string;\n  level: number; // 1-10 (1=Admin, 10=ReadOnly)\n  created_at?: string;\n  updated_at?: string;\n}\n\nexport interface Permission {\n  id?: number;\n  resource: string; // 'customers', 'reports', 'settings'\n  action: string; // 'create', 'read', 'update', 'delete', 'export'\n  conditions?: string; // JSON f√ºr ABAC-Bedingungen\n  created_at?: string;\n}\n\nexport interface UserRole {\n  id?: number;\n  user_id: number;\n  role_id: number;\n  assigned_by: number;\n  assigned_at: string;\n  expires_at?: string;\n}\n\nexport interface RolePermission {\n  id?: number;\n  role_id: number;\n  permission_id: number;\n  granted: boolean;\n  created_at?: string;\n}\n\nexport interface AccessContext {\n  user_id: number;\n  resource: string;\n  action: string;\n  attributes?: Record<string, any>;\n  ip_address?: string;\n  user_agent?: string;\n}\n\n// =====================================================\n// RBAC/ABAC SERVICE CLASS\n// =====================================================\n\nexport class RBACService {\n  // =====================================================\n  // BENUTZER-MANAGEMENT\n  // =====================================================\n\n  static async createUser(userData: Omit<User, \"id\" | \"created_at\" | \"updated_at\">): Promise<User> {\n    try {\n      const connection = await getConnection();\n\n      const [result] = await connection.execute(\n        `\n                INSERT INTO lopez_users (username, email, password_hash, first_name, last_name, status)\n                VALUES (?, ?, ?, ?, ?, ?)\n            `,\n        [\n          userData.username,\n          userData.email,\n          userData.password_hash,\n          userData.first_name,\n          userData.last_name,\n          userData.status,\n        ],\n      );\n\n      const insertId = (result as any).insertId;\n      const user = await this.getUserById(insertId);\n\n      return user!;\n    } catch (error) {\n      console.error(\"‚ùå Fehler beim Erstellen des Benutzers:\", error);\n      throw error;\n    }\n  }\n\n  static async getUserById(id: number): Promise<User | null> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\"SELECT * FROM lopez_users WHERE id = ?\", [id]);\n\n      const users = rows as User[];\n      return users.length > 0 ? users[0] : null;\n    } catch (error) {\n      console.error(\"‚ùå Fehler beim Laden des Benutzers:\", error);\n      throw error;\n    }\n  }\n\n  static async getUserByUsername(username: string): Promise<User | null> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\"SELECT * FROM lopez_users WHERE username = ?\", [\n        username,\n      ]);\n\n      const users = rows as User[];\n      return users.length > 0 ? users[0] : null;\n    } catch (error) {\n      console.error(\"‚ùå Fehler beim Laden des Benutzers:\", error);\n      throw error;\n    }\n  }\n\n  static async getUserByEmail(email: string): Promise<User | null> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\"SELECT * FROM lopez_users WHERE email = ?\", [email]);\n\n      const users = rows as User[];\n      return users.length > 0 ? users[0] : null;\n    } catch (error) {\n      console.error(\"‚ùå Fehler beim Laden des Benutzers:\", error);\n      throw error;\n    }\n  }\n\n  // =====================================================\n  // ROLLEN-MANAGEMENT\n  // =====================================================\n\n  static async createRole(roleData: Omit<Role, \"id\" | \"created_at\" | \"updated_at\">): Promise<Role> {\n    try {\n      const connection = await getConnection();\n\n      const [result] = await connection.execute(\n        `\n                INSERT INTO lopez_roles (name, description, level)\n                VALUES (?, ?, ?)\n            `,\n        [roleData.name, roleData.description, roleData.level],\n      );\n\n      const insertId = (result as any).insertId;\n      const role = await this.getRoleById(insertId);\n\n      return role!;\n    } catch (error) {\n      console.error(\"‚ùå Fehler beim Erstellen der Rolle:\", error);\n      throw error;\n    }\n  }\n\n  static async getRoleById(id: number): Promise<Role | null> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\"SELECT * FROM lopez_roles WHERE id = ?\", [id]);\n\n      const roles = rows as Role[];\n      return roles.length > 0 ? roles[0] : null;\n    } catch (error) {\n      console.error(\"‚ùå Fehler beim Laden der Rolle:\", error);\n      throw error;\n    }\n  }\n\n  static async getAllRoles(): Promise<Role[]> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\"SELECT * FROM lopez_roles ORDER BY level ASC\");\n\n      return rows as Role[];\n    } catch (error) {\n      console.error(\"‚ùå Fehler beim Laden der Rollen:\", error);\n      throw error;\n    }\n  }\n\n  // =====================================================\n  // BERECHTIGUNGS-MANAGEMENT\n  // =====================================================\n\n  static async createPermission(\n    permissionData: Omit<Permission, \"id\" | \"created_at\">,\n  ): Promise<Permission> {\n    try {\n      const connection = await getConnection();\n\n      const [result] = await connection.execute(\n        `\n                INSERT INTO lopez_permissions (resource, action, conditions)\n                VALUES (?, ?, ?)\n            `,\n        [\n          permissionData.resource,\n          permissionData.action,\n          permissionData.conditions ? JSON.stringify(permissionData.conditions) : null,\n        ],\n      );\n\n      const insertId = (result as any).insertId;\n      const permission = await this.getPermissionById(insertId);\n\n      return permission!;\n    } catch (error) {\n      console.error(\"‚ùå Fehler beim Erstellen der Berechtigung:\", error);\n      throw error;\n    }\n  }\n\n  static async getPermissionById(id: number): Promise<Permission | null> {\n    try {\n      const connection = await getConnection();\n      const [rows] = await connection.execute(\"SELECT * FROM lopez_permissions WHERE id = ?\", [id]);\n\n      const permissions = rows as Permission[];\n      return permissions.length > 0 ? permissions[0] : null;\n    } catch (error) {\n      console.error(\"‚ùå Fehler beim Laden der Berechtigung:\", error);\n      throw error;\n    }\n  }\n\n  // =====================================================\n  // ZUGRIFFSKONTROLLE\n  // =====================================================\n\n  static async checkPermission(context: AccessContext): Promise<boolean> {\n    try {\n      const connection = await getConnection();\n\n      // Benutzer-Rollen laden\n      const [userRoles] = await connection.execute(\n        `\n                SELECT r.*, ur.expires_at\n                FROM lopez_user_roles ur\n                JOIN lopez_roles r ON ur.role_id = r.id\n                WHERE ur.user_id = ? AND (ur.expires_at IS NULL OR ur.expires_at > NOW())\n            `,\n        [context.user_id],\n      );\n\n      if ((userRoles as any[]).length === 0) {\n        return false;\n      }\n\n      // Berechtigungen f√ºr jede Rolle pr√ºfen\n      for (const userRole of userRoles as any[]) {\n        const [permissions] = await connection.execute(\n          `\n                    SELECT p.*, rp.granted\n                    FROM lopez_role_permissions rp\n                    JOIN lopez_permissions p ON rp.permission_id = p.id\n                    WHERE rp.role_id = ? AND p.resource = ? AND p.action = ?\n                `,\n          [userRole.id, context.resource, context.action],\n        );\n\n        for (const permission of permissions as any[]) {\n          if (permission.granted) {\n            // ABAC-Bedingungen pr√ºfen\n            if (permission.conditions) {\n              const conditions = JSON.parse(permission.conditions);\n              if (await this.evaluateABACConditions(conditions, context)) {\n                return true;\n              }\n            } else {\n              return true;\n            }\n          }\n        }\n      }\n\n      return false;\n    } catch (error) {\n      console.error(\"‚ùå Fehler bei der Berechtigungspr√ºfung:\", error);\n      return false;\n    }\n  }\n\n  static async evaluateABACConditions(conditions: any, context: AccessContext): Promise<boolean> {\n    try {\n      // Einfache ABAC-Bedingungsauswertung\n      // In Produktion: Vollst√§ndige ABAC-Engine implementieren\n\n      for (const [key, value] of Object.entries(conditions)) {\n        if (context.attributes && context.attributes[key] !== value) {\n          return false;\n        }\n      }\n\n      return true;\n    } catch (error) {\n      console.error(\"‚ùå Fehler bei der ABAC-Auswertung:\", error);\n      return false;\n    }\n  }\n\n  // =====================================================\n  // ROLLEN-ZUWEISUNG\n  // =====================================================\n\n  static async assignRoleToUser(\n    userId: number,\n    roleId: number,\n    assignedBy: number,\n    expiresAt?: string,\n  ): Promise<boolean> {\n    try {\n      const connection = await getConnection();\n\n      await connection.execute(\n        `\n                INSERT INTO lopez_user_roles (user_id, role_id, assigned_by, assigned_at, expires_at)\n                VALUES (?, ?, ?, NOW(), ?)\n            `,\n        [userId, roleId, assignedBy, expiresAt || null],\n      );\n\n      return true;\n    } catch (error) {\n      console.error(\"‚ùå Fehler bei der Rollen-Zuweisung:\", error);\n      return false;\n    }\n  }\n\n  static async removeRoleFromUser(userId: number, roleId: number): Promise<boolean> {\n    try {\n      const connection = await getConnection();\n\n      await connection.execute(\n        `\n                DELETE FROM lopez_user_roles \n                WHERE user_id = ? AND role_id = ?\n            `,\n        [userId, roleId],\n      );\n\n      return true;\n    } catch (error) {\n      console.error(\"‚ùå Fehler bei der Rollen-Entfernung:\", error);\n      return false;\n    }\n  }\n\n  // =====================================================\n  // BERECHTIGUNGS-ZUWEISUNG\n  // =====================================================\n\n  static async assignPermissionToRole(\n    roleId: number,\n    permissionId: number,\n    granted: boolean = true,\n  ): Promise<boolean> {\n    try {\n      const connection = await getConnection();\n\n      await connection.execute(\n        `\n                INSERT INTO lopez_role_permissions (role_id, permission_id, granted)\n                VALUES (?, ?, ?)\n                ON DUPLICATE KEY UPDATE granted = ?\n            `,\n        [roleId, permissionId, granted, granted],\n      );\n\n      return true;\n    } catch (error) {\n      console.error(\"‚ùå Fehler bei der Berechtigungs-Zuweisung:\", error);\n      return false;\n    }\n  }\n\n  // =====================================================\n  // BENUTZER-ROLLEN ABRUFEN\n  // =====================================================\n\n  static async getUserRoles(userId: number): Promise<Role[]> {\n    try {\n      const connection = await getConnection();\n\n      const [rows] = await connection.execute(\n        `\n                SELECT r.*\n                FROM lopez_user_roles ur\n                JOIN lopez_roles r ON ur.role_id = r.id\n                WHERE ur.user_id = ? AND (ur.expires_at IS NULL OR ur.expires_at > NOW())\n            `,\n        [userId],\n      );\n\n      return rows as Role[];\n    } catch (error) {\n      console.error(\"‚ùå Fehler beim Laden der Benutzer-Rollen:\", error);\n      throw error;\n    }\n  }\n\n  // =====================================================\n  // ROLLEN-BERECHTIGUNGEN ABRUFEN\n  // =====================================================\n\n  static async getRolePermissions(roleId: number): Promise<Permission[]> {\n    try {\n      const connection = await getConnection();\n\n      const [rows] = await connection.execute(\n        `\n                SELECT p.*, rp.granted\n                FROM lopez_role_permissions rp\n                JOIN lopez_permissions p ON rp.permission_id = p.id\n                WHERE rp.role_id = ? AND rp.granted = true\n            `,\n        [roleId],\n      );\n\n      return rows as Permission[];\n    } catch (error) {\n      console.error(\"‚ùå Fehler beim Laden der Rollen-Berechtigungen:\", error);\n      throw error;\n    }\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2864, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/lib/admin-auth-service.ts"],"sourcesContent":["// =====================================================\r\n// ADMIN AUTH SERVICE - LOPEZ IT WELT\r\n// =====================================================\r\n// Erstellt: 2025-11-01\r\n// Zweck: Admin-Authentifizierung (Username ODER Email + 2FA Pflicht)\r\n// Status: ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT\r\n// =====================================================\r\n\r\nimport bcrypt from \"bcryptjs\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport { TwoFactorService } from \"./2fa-service\";\r\nimport { getConnection } from \"./database\";\r\nimport { DevelopmentMode } from \"./development-mode\";\r\nimport { RBACService, User } from \"./rbac-system\";\r\n\r\n// =====================================================\r\n// INTERFACES\r\n// =====================================================\r\n\r\nexport interface AdminLoginCredentials {\r\n  identifier: string; // Username ODER Email\r\n  password: string;\r\n  twoFactorToken?: string;\r\n}\r\n\r\nexport interface AdminSessionData {\r\n  userId: number;\r\n  username: string;\r\n  email: string;\r\n  roles: string[];\r\n  permissions: string[];\r\n  sessionToken: string;\r\n  expiresAt: Date;\r\n  realm: \"ADMIN\";\r\n}\r\n\r\nexport interface AdminAuthResult {\r\n  success: boolean;\r\n  message: string;\r\n  session?: AdminSessionData;\r\n  requires2FA?: boolean;\r\n  lockoutUntil?: Date;\r\n}\r\n\r\n// =====================================================\r\n// ADMIN AUTH SERVICE CLASS\r\n// =====================================================\r\n\r\nexport class AdminAuthService {\r\n  private static readonly JWT_SECRET = process.env.JWT_SECRET || \"lopez-it-welt-secret-key\";\r\n  private static readonly JWT_EXPIRES_IN = \"24h\";\r\n  private static readonly SESSION_EXPIRES_IN = 24 * 60 * 60 * 1000; // 24 Stunden\r\n  private static readonly MAX_LOGIN_ATTEMPTS = 5;\r\n  private static readonly LOCKOUT_DURATION = 15 * 60 * 1000; // 15 Minuten\r\n\r\n  // =====================================================\r\n  // LOGIN & AUTHENTIFIZIERUNG\r\n  // =====================================================\r\n\r\n  static async login(\r\n    credentials: AdminLoginCredentials,\r\n    ipAddress?: string,\r\n    userAgent?: string,\r\n  ): Promise<AdminAuthResult> {\r\n    try {\r\n      // Development Mode: Authentication umgehen\r\n      if (DevelopmentMode.shouldBypassAuth()) {\r\n        console.log(\"üöÄ Development Mode: Admin Login umgangen\");\r\n        const mockUser = DevelopmentMode.createMockUser();\r\n\r\n        return {\r\n          success: true,\r\n          message: \"Development Mode: Login erfolgreich\",\r\n          session: {\r\n            userId: mockUser.id as number,\r\n            username: mockUser.username,\r\n            email: mockUser.email,\r\n            roles: [\"admin\"],\r\n            permissions: [\"*\"],\r\n            sessionToken: \"dev-mode-token\",\r\n            expiresAt: new Date(Date.now() + this.SESSION_EXPIRES_IN),\r\n            realm: \"ADMIN\",\r\n          },\r\n        };\r\n      }\r\n\r\n      // Benutzer laden (Username ODER Email)\r\n      let user = await RBACService.getUserByUsername(credentials.identifier);\r\n      if (!user) {\r\n        // Fallback: Versuche Email als Identifier\r\n        user = await RBACService.getUserByEmail(credentials.identifier);\r\n      }\r\n\r\n      if (!user) {\r\n        return {\r\n          success: false,\r\n          message: \"Benutzername oder Passwort falsch\",\r\n        };\r\n      }\r\n\r\n      // Lockout-Pr√ºfung\r\n      const lockoutUntil = await this.checkLockout(user.id!);\r\n      if (lockoutUntil) {\r\n        return {\r\n          success: false,\r\n          message: `Konto gesperrt. Versuchen Sie es erneut um ${lockoutUntil.toLocaleTimeString()}`,\r\n          lockoutUntil,\r\n        };\r\n      }\r\n\r\n      // Passwort pr√ºfen\r\n      const passwordValid = await bcrypt.compare(credentials.password, user.password_hash);\r\n      if (!passwordValid) {\r\n        await this.recordFailedAttempt(user.id!, ipAddress);\r\n        return {\r\n          success: false,\r\n          message: \"Benutzername oder Passwort falsch\",\r\n        };\r\n      }\r\n\r\n      // Benutzer-Status pr√ºfen\r\n      if (user.status !== \"active\") {\r\n        return {\r\n          success: false,\r\n          message: \"Benutzerkonto ist nicht aktiv\",\r\n        };\r\n      }\r\n\r\n      // 2FA PR√úFEN (PFLICHT f√ºr Admin)\r\n      const requires2FA = await TwoFactorService.is2FAEnabled(user.id!);\r\n      if (!requires2FA) {\r\n        // 2FA noch nicht aktiviert - erfordern\r\n        return {\r\n          success: false,\r\n          message: \"Zwei-Faktor-Authentifizierung erforderlich. Bitte aktivieren Sie 2FA zuerst.\",\r\n          requires2FA: true,\r\n        };\r\n      }\r\n\r\n      if (!credentials.twoFactorToken) {\r\n        return {\r\n          success: false,\r\n          message: \"Zwei-Faktor-Authentifizierung erforderlich\",\r\n          requires2FA: true,\r\n        };\r\n      }\r\n\r\n      const twoFactorValid = await TwoFactorService.verifyToken(\r\n        user.id!,\r\n        credentials.twoFactorToken,\r\n      );\r\n      if (!twoFactorValid) {\r\n        await this.recordFailedAttempt(user.id!, ipAddress);\r\n        return {\r\n          success: false,\r\n          message: \"Zwei-Faktor-Token ung√ºltig\",\r\n        };\r\n      }\r\n\r\n      // Erfolgreicher Login - Failed Attempts zur√ºcksetzen\r\n      await this.resetFailedAttempts(user.id!);\r\n\r\n      // Session erstellen\r\n      const session = await this.createSession(user, ipAddress, userAgent);\r\n      if (!session) {\r\n        return {\r\n          success: false,\r\n          message: \"Session konnte nicht erstellt werden\",\r\n        };\r\n      }\r\n\r\n      // Last Login aktualisieren\r\n      await this.updateLastLogin(user.id!);\r\n\r\n      return {\r\n        success: true,\r\n        message: \"Login erfolgreich\",\r\n        session,\r\n      };\r\n    } catch (error) {\r\n      console.error(\"‚ùå Admin Login fehlgeschlagen:\", error);\r\n      return {\r\n        success: false,\r\n        message: \"Interner Serverfehler\",\r\n      };\r\n    }\r\n  }\r\n\r\n  // =====================================================\r\n  // SESSION-MANAGEMENT\r\n  // =====================================================\r\n\r\n  static async createSession(\r\n    user: User,\r\n    ipAddress?: string,\r\n    userAgent?: string,\r\n  ): Promise<AdminSessionData | null> {\r\n    try {\r\n      const connection = await getConnection();\r\n\r\n      // Session-Token generieren\r\n      const sessionToken = this.generateSessionToken();\r\n      const expiresAt = new Date(Date.now() + this.SESSION_EXPIRES_IN);\r\n\r\n      // Session in Datenbank speichern (mit adm_ Pr√§fix in Session-Daten)\r\n      await connection.execute(\r\n        `\r\n                INSERT INTO lopez_sessions (user_id, session_token, ip_address, user_agent, expires_at)\r\n                VALUES (?, ?, ?, ?, ?)\r\n            `,\r\n        [user.id, `adm_${sessionToken}`, ipAddress, userAgent, expiresAt],\r\n      );\r\n\r\n      // Benutzer-Rollen laden\r\n      const roles = await RBACService.getUserRoles(user.id!);\r\n      const roleNames = roles.map((role) => role.name);\r\n\r\n      // Berechtigungen sammeln\r\n      const permissions: string[] = [];\r\n      for (const role of roles) {\r\n        const rolePermissions = await RBACService.getRolePermissions(role.id!);\r\n        permissions.push(...rolePermissions.map((p) => `${p.resource}.${p.action}`));\r\n      }\r\n\r\n      return {\r\n        userId: user.id!,\r\n        username: user.username,\r\n        email: user.email,\r\n        roles: roleNames,\r\n        permissions: [...new Set(permissions)], // Duplikate entfernen\r\n        sessionToken: `adm_${sessionToken}`,\r\n        expiresAt,\r\n        realm: \"ADMIN\",\r\n      };\r\n    } catch (error) {\r\n      console.error(\"‚ùå Session-Erstellung fehlgeschlagen:\", error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  static async validateSession(sessionToken: string): Promise<AdminSessionData | null> {\r\n    try {\r\n      if (!sessionToken.startsWith(\"adm_\")) {\r\n        return null;\r\n      }\r\n\r\n      const connection = await getConnection();\r\n      const [rows] = await connection.execute(\r\n        `\r\n                SELECT s.*, u.username, u.email, u.status\r\n                FROM lopez_sessions s\r\n                JOIN lopez_users u ON s.user_id = u.id\r\n                WHERE s.session_token = ? AND s.expires_at > NOW() AND u.status = 'active'\r\n            `,\r\n        [sessionToken],\r\n      );\r\n\r\n      if ((rows as any[]).length === 0) {\r\n        return null;\r\n      }\r\n\r\n      const session = (rows as any)[0];\r\n      const roles = await RBACService.getUserRoles(session.user_id);\r\n      const roleNames = roles.map((role) => role.name);\r\n\r\n      const permissions: string[] = [];\r\n      for (const role of roles) {\r\n        const rolePermissions = await RBACService.getRolePermissions(role.id!);\r\n        permissions.push(...rolePermissions.map((p) => `${p.resource}.${p.action}`));\r\n      }\r\n\r\n      return {\r\n        userId: session.user_id,\r\n        username: session.username,\r\n        email: session.email,\r\n        roles: roleNames,\r\n        permissions: [...new Set(permissions)],\r\n        sessionToken: session.session_token,\r\n        expiresAt: session.expires_at,\r\n        realm: \"ADMIN\",\r\n      };\r\n    } catch (error) {\r\n      console.error(\"‚ùå Session-Validierung fehlgeschlagen:\", error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  static async logout(sessionToken: string): Promise<boolean> {\r\n    try {\r\n      if (!sessionToken.startsWith(\"adm_\")) {\r\n        return false;\r\n      }\r\n\r\n      const connection = await getConnection();\r\n      await connection.execute(\"DELETE FROM lopez_sessions WHERE session_token = ?\", [sessionToken]);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(\"‚ùå Logout fehlgeschlagen:\", error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // =====================================================\r\n  // JWT-TOKEN\r\n  // =====================================================\r\n\r\n  static generateJWT(session: AdminSessionData): string {\r\n    return jwt.sign(\r\n      {\r\n        userId: session.userId,\r\n        username: session.username,\r\n        email: session.email,\r\n        roles: session.roles,\r\n        realm: \"ADMIN\",\r\n      },\r\n      this.JWT_SECRET,\r\n      { expiresIn: this.JWT_EXPIRES_IN },\r\n    );\r\n  }\r\n\r\n  static verifyJWT(token: string): any {\r\n    try {\r\n      return jwt.verify(token, this.JWT_SECRET);\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // =====================================================\r\n  // LOCKOUT & FAILED ATTEMPTS\r\n  // =====================================================\r\n\r\n  private static async checkLockout(userId: number): Promise<Date | null> {\r\n    try {\r\n      const connection = await getConnection();\r\n      // Pr√ºfe ob Spalten existieren (optional - Lockout kann sp√§ter aktiviert werden)\r\n      try {\r\n        const [rows] = await connection.execute(\r\n          `\r\n                    SELECT failed_login_attempts, locked_until\r\n                    FROM lopez_users\r\n                    WHERE id = ?\r\n                `,\r\n          [userId],\r\n        );\r\n\r\n        if ((rows as any[]).length === 0) {\r\n          return null;\r\n        }\r\n\r\n        const user = (rows as any)[0];\r\n        if (user.locked_until && new Date(user.locked_until) > new Date()) {\r\n          return new Date(user.locked_until);\r\n        }\r\n      } catch (error) {\r\n        // Spalten existieren nicht - Lockout deaktiviert\r\n        return null;\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private static async recordFailedAttempt(userId: number, ipAddress?: string): Promise<void> {\r\n    try {\r\n      const connection = await getConnection();\r\n      // Pr√ºfe ob Spalten existieren (optional - Lockout kann sp√§ter aktiviert werden)\r\n      try {\r\n        const [rows] = await connection.execute(\r\n          \"SELECT failed_login_attempts FROM lopez_users WHERE id = ?\",\r\n          [userId],\r\n        );\r\n\r\n        const currentAttempts = ((rows as any)[0]?.failed_login_attempts || 0) + 1;\r\n        const lockoutUntil =\r\n          currentAttempts >= this.MAX_LOGIN_ATTEMPTS\r\n            ? new Date(Date.now() + this.LOCKOUT_DURATION)\r\n            : null;\r\n\r\n        await connection.execute(\r\n          `\r\n                    UPDATE lopez_users\r\n                    SET failed_login_attempts = ?,\r\n                        locked_until = ?\r\n                    WHERE id = ?\r\n                `,\r\n          [currentAttempts, lockoutUntil, userId],\r\n        );\r\n      } catch (error) {\r\n        // Spalten existieren nicht - Lockout deaktiviert (nicht kritisch)\r\n        console.warn(\"‚ö†Ô∏è Lockout-Spalten nicht vorhanden - Lockout deaktiviert\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"‚ùå Failed Attempt Recording fehlgeschlagen:\", error);\r\n    }\r\n  }\r\n\r\n  private static async resetFailedAttempts(userId: number): Promise<void> {\r\n    try {\r\n      const connection = await getConnection();\r\n      // Pr√ºfe ob Spalten existieren (optional - Lockout kann sp√§ter aktiviert werden)\r\n      try {\r\n        await connection.execute(\r\n          `\r\n                    UPDATE lopez_users\r\n                    SET failed_login_attempts = 0,\r\n                        locked_until = NULL\r\n                    WHERE id = ?\r\n                `,\r\n          [userId],\r\n        );\r\n      } catch (error) {\r\n        // Spalten existieren nicht - Lockout deaktiviert (nicht kritisch)\r\n      }\r\n    } catch (error) {\r\n      console.error(\"‚ùå Failed Attempts Reset fehlgeschlagen:\", error);\r\n    }\r\n  }\r\n\r\n  // =====================================================\r\n  // HILFSFUNKTIONEN\r\n  // =====================================================\r\n\r\n  private static generateSessionToken(): string {\r\n    return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  private static async updateLastLogin(userId: number): Promise<void> {\r\n    try {\r\n      const connection = await getConnection();\r\n      await connection.execute(\r\n        \"UPDATE lopez_users SET last_login = NOW() WHERE id = ?\",\r\n        [userId],\r\n      );\r\n    } catch (error) {\r\n      console.error(\"‚ùå Last Login Update fehlgeschlagen:\", error);\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3244, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/app/api/auth/admin/login/route.ts"],"sourcesContent":["// =====================================================\r\n// ADMIN LOGIN API - LOPEZ IT WELT\r\n// =====================================================\r\n// Erstellt: 2025-11-01\r\n// Zweck: Admin-Authentifizierung (Username ODER Email + 2FA Pflicht)\r\n// Status: ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT\r\n// =====================================================\r\n\r\nimport { AuditService } from \"@/lib/audit-service\";\r\nimport { AdminAuthService } from \"@/lib/admin-auth-service\";\r\nimport { DevelopmentMode } from \"@/lib/development-mode\";\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\n\r\n// =====================================================\r\n// POST - Admin-Login\r\n// =====================================================\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // Development Mode: Authentication umgehen\r\n    if (DevelopmentMode.shouldBypassAuth()) {\r\n      const mockResponse = DevelopmentMode.createLoginResponse();\r\n      return NextResponse.json(mockResponse);\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { identifier, password, twoFactorToken } = body;\r\n\r\n    if (!identifier || !password) {\r\n      return NextResponse.json(\r\n        { success: false, message: \"Benutzername/E-Mail und Passwort erforderlich\" },\r\n        { status: 400 },\r\n      );\r\n    }\r\n\r\n    // IP-Adresse und User-Agent extrahieren\r\n    const ipAddress =\r\n      request.headers.get(\"x-forwarded-for\") || request.headers.get(\"x-real-ip\") || \"unknown\";\r\n    const userAgent = request.headers.get(\"user-agent\") || \"unknown\";\r\n    const route = request.nextUrl.pathname;\r\n\r\n    // Login durchf√ºhren\r\n    const authResult = await AdminAuthService.login(\r\n      { identifier, password, twoFactorToken },\r\n      ipAddress,\r\n      userAgent,\r\n    );\r\n\r\n    if (!authResult.success) {\r\n      // Audit-Log f√ºr fehlgeschlagenen Login\r\n      await AuditService.logAudit({\r\n        table_name: \"lopez_users\",\r\n        record_id: 0,\r\n        action: \"LOGIN\",\r\n        user_id: 0,\r\n        username: identifier,\r\n        ip_address: ipAddress,\r\n        user_agent: userAgent,\r\n        session_id: null,\r\n        risk_level: \"MEDIUM\",\r\n        compliance_category: \"AUTHENTICATION\",\r\n        new_values: JSON.stringify({\r\n          realm: \"ADMIN\",\r\n          result: \"failed\",\r\n          reason: authResult.message,\r\n          route,\r\n        }),\r\n      });\r\n\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          message: authResult.message,\r\n          requires2FA: authResult.requires2FA,\r\n          lockoutUntil: authResult.lockoutUntil,\r\n        },\r\n        { status: 401 },\r\n      );\r\n    }\r\n\r\n    // JWT-Token generieren\r\n    const jwtToken = AdminAuthService.generateJWT(authResult.session!);\r\n\r\n    // Cookie setzen (mit adm_ Pr√§fix)\r\n    const response = NextResponse.json({\r\n      success: true,\r\n      message: \"Login erfolgreich\",\r\n      data: {\r\n        user: {\r\n          id: authResult.session!.userId,\r\n          username: authResult.session!.username,\r\n          email: authResult.session!.email,\r\n          roles: authResult.session!.roles,\r\n        },\r\n        token: jwtToken,\r\n        sessionToken: authResult.session!.sessionToken,\r\n        expiresAt: authResult.session!.expiresAt,\r\n      },\r\n    });\r\n\r\n    // Cookie mit adm_ Pr√§fix setzen\r\n    response.cookies.set(\"adm_session\", authResult.session!.sessionToken, {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === \"production\",\r\n      sameSite: \"lax\",\r\n      maxAge: 24 * 60 * 60, // 24 Stunden\r\n      path: \"/\",\r\n    });\r\n\r\n    response.cookies.set(\"adm_token\", jwtToken, {\r\n      httpOnly: false,\r\n      secure: process.env.NODE_ENV === \"production\",\r\n      sameSite: \"lax\",\r\n      maxAge: 24 * 60 * 60,\r\n      path: \"/\",\r\n    });\r\n\r\n    // Audit-Log f√ºr erfolgreichen Login\r\n    await AuditService.logAudit({\r\n      table_name: \"lopez_users\",\r\n      record_id: authResult.session!.userId,\r\n      action: \"LOGIN\",\r\n      user_id: authResult.session!.userId,\r\n      username: authResult.session!.username,\r\n      ip_address: ipAddress,\r\n      user_agent: userAgent,\r\n      session_id: authResult.session!.sessionToken,\r\n      risk_level: \"LOW\",\r\n      compliance_category: \"AUTHENTICATION\",\r\n      new_values: JSON.stringify({\r\n        realm: \"ADMIN\",\r\n        result: \"success\",\r\n        route,\r\n      }),\r\n    });\r\n\r\n    // Automatische Zeiterfassung nach Admin-Login starten\r\n    try {\r\n      const { promises: fs } = await import(\"fs\");\r\n      const path = await import(\"path\");\r\n      \r\n      const SESSIONS_FILE = path.join(process.cwd(), \"data\", \"time-sessions.json\");\r\n      \r\n      let sessions: any[] = [];\r\n      try {\r\n        const data = await fs.readFile(SESSIONS_FILE, \"utf-8\");\r\n        sessions = JSON.parse(data);\r\n      } catch {\r\n        sessions = [];\r\n      }\r\n      \r\n      const activeSession = sessions.find(\r\n        (s) => s.user_id === authResult.session!.userId && s.status === \"active\" && !s.end_time\r\n      );\r\n      \r\n      if (!activeSession) {\r\n        const now = new Date().toISOString();\r\n        const maxId = sessions.length > 0 ? Math.max(...sessions.map((s: any) => s.id || 0)) : 0;\r\n        \r\n        const newSession = {\r\n          id: maxId + 1,\r\n          user_id: authResult.session!.userId,\r\n          module: \"Login-Session\",\r\n          taetigkeit: `System-Login: ${authResult.session!.username}`,\r\n          ausloeser: \"Automatische Zeiterfassung nach erfolgreichem Admin-Login\",\r\n          problem: false,\r\n          category: \"administration\",\r\n          priority: \"high\",\r\n          project_id: null,\r\n          task_id: null,\r\n          start_time: now,\r\n          status: \"active\",\r\n          created_at: now,\r\n          updated_at: now,\r\n        };\r\n        \r\n        sessions.push(newSession);\r\n        \r\n        const dir = path.dirname(SESSIONS_FILE);\r\n        await fs.mkdir(dir, { recursive: true });\r\n        await fs.writeFile(SESSIONS_FILE, JSON.stringify(sessions, null, 2));\r\n        \r\n        // Audit-Log f√ºr Zeiterfassung\r\n        await AuditService.logAudit({\r\n          table_name: \"work_sessions\",\r\n          record_id: newSession.id,\r\n          action: \"INSERT\",\r\n          new_values: JSON.stringify({\r\n            user_id: authResult.session!.userId,\r\n            username: authResult.session!.username,\r\n            module: \"Login-Session\",\r\n            taetigkeit: newSession.taetigkeit,\r\n            status: \"active\",\r\n            realm: \"ADMIN\",\r\n          }),\r\n          user_id: authResult.session!.userId,\r\n          username: authResult.session!.username,\r\n          ip_address: ipAddress,\r\n          user_agent: userAgent,\r\n          session_id: authResult.session!.sessionToken,\r\n          risk_level: \"LOW\",\r\n          compliance_category: \"DATA_MODIFICATION\",\r\n        });\r\n      }\r\n    } catch (timeTrackingError) {\r\n      console.warn(\"‚ö†Ô∏è Automatische Zeiterfassung nach Admin-Login fehlgeschlagen:\", timeTrackingError);\r\n    }\r\n\r\n    return response;\r\n  } catch (error) {\r\n    console.error(\"‚ùå Admin Login API Fehler:\", error);\r\n    // Detaillierte Fehler-Logging f√ºr Debugging\r\n    if (error instanceof Error) {\r\n      console.error(\"Fehler-Details:\", error.message);\r\n      console.error(\"Stack:\", error.stack);\r\n    }\r\n    return NextResponse.json(\r\n      { \r\n        success: false, \r\n        message: \"Interner Serverfehler\",\r\n        error: process.env.NODE_ENV === \"development\" ? (error instanceof Error ? error.message : String(error)) : undefined\r\n      }, \r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}