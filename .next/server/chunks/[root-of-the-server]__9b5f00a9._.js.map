{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/lib/db.ts"],"sourcesContent":["import mysql from \"mysql2/promise\";\n\n/**\n * Zentrale MySQL-Datenbankverbindung mit UTF-8 Konfiguration\n * Enterprise++ Standard für alle API-Routen\n *\n * @author Ramiro Lopez Rodriguez\n * @version 1.0.0\n * @date 2025-09-28\n */\n\n// MySQL-Verbindungskonfiguration - MySQL2-kompatibel\nconst dbConfig = {\n  host: \"localhost\",\n  user: \"root\",\n  password: \"\",\n  database: \"lopez_it_welt\",\n  port: 3306,\n  charset: \"utf8mb4\",\n  supportBigNumbers: true,\n  bigNumberStrings: true,\n  // MySQL2-spezifische Pool-Optionen\n  waitForConnections: true,\n  connectionLimit: 10,\n  queueLimit: 0,\n  acquireTimeout: 60000,\n  timeout: 60000,\n};\n\n// Verbindungspool für bessere Performance\nlet pool: mysql.Pool | null = null;\n\n/**\n * Erstellt oder gibt bestehenden Verbindungspool zurück\n */\nexport function getConnectionPool(): mysql.Pool {\n  if (!pool) {\n    pool = mysql.createPool({\n      host: \"localhost\",\n      user: \"root\",\n      password: \"\",\n      database: \"lopez_it_welt\",\n      port: 3306,\n      charset: \"utf8mb4\",\n      supportBigNumbers: true,\n      bigNumberStrings: true,\n      // Pool-spezifische Konfiguration (nur gültige Optionen)\n      waitForConnections: true,\n      connectionLimit: 10,\n      queueLimit: 0,\n    });\n  }\n  return pool;\n}\n\n/**\n * Erstellt eine neue Datenbankverbindung mit UTF-8 Konfiguration\n */\nexport async function createConnection(): Promise<mysql.Connection> {\n  try {\n    const connection = await mysql.createConnection(dbConfig);\n\n    // UTF-8 explizit setzen für maximale Kompatibilität\n    await connection.execute(\"SET NAMES utf8mb4\");\n    await connection.execute(\"SET CHARACTER SET utf8mb4\");\n    await connection.execute(\"SET character_set_connection=utf8mb4\");\n    await connection.execute(\"SET character_set_results=utf8mb4\");\n    await connection.execute(\"SET character_set_client=utf8mb4\");\n\n    return connection;\n  } catch (error) {\n    console.error(\"❌ MySQL-Verbindung fehlgeschlagen:\", error);\n    throw new Error(\n      `Datenbankverbindung fehlgeschlagen: ${error instanceof Error ? error.message : \"Unbekannter Fehler\"}`,\n    );\n  }\n}\n\n/**\n * Führt eine Query mit UTF-8 Konfiguration aus\n */\nexport async function executeQuery<T = any>(sql: string, params: any[] = []): Promise<T> {\n  const connection = await createConnection();\n  try {\n    const [rows] = await connection.execute(sql, params);\n    return rows as T;\n  } finally {\n    await connection.end();\n  }\n}\n\n/**\n * Führt eine Query mit Verbindungspool aus (für häufige Abfragen)\n */\nexport async function executeQueryPool<T = any>(sql: string, params: any[] = []): Promise<T> {\n  const pool = getConnectionPool();\n  const [rows] = await pool.execute(sql, params);\n  return rows as T;\n}\n\n/**\n * Schließt den Verbindungspool (beim Herunterfahren)\n */\nexport async function closePool(): Promise<void> {\n  if (pool) {\n    await pool.end();\n    pool = null;\n  }\n}\n\n/**\n * Testet die Datenbankverbindung\n */\nexport async function testConnection(): Promise<boolean> {\n  try {\n    const connection = await createConnection();\n    await connection.execute(\"SELECT 1\");\n    await connection.end();\n    return true;\n  } catch (error) {\n    console.error(\"❌ Datenbankverbindung fehlgeschlagen:\", error);\n    return false;\n  }\n}\n\n/**\n * Prüft UTF-8 Konfiguration der Datenbank\n */\nexport async function checkUTF8Config(): Promise<{\n  database: string;\n  server: string;\n  connection: string;\n  results: string;\n}> {\n  const connection = await createConnection();\n  try {\n    const [rows] = await connection.execute(`\n      SELECT \n        @@character_set_database as database,\n        @@character_set_server as server,\n        @@character_set_connection as connection,\n        @@character_set_results as results\n    `);\n\n    const result = (rows as any[])[0];\n    await connection.end();\n\n    return {\n      database: result.database,\n      server: result.server,\n      connection: result.connection,\n      results: result.results,\n    };\n  } catch (error) {\n    await connection.end();\n    throw error;\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;AAEA;;;;;;;CAOC,GAED,qDAAqD;AACrD,MAAM,WAAW;IACf,MAAM;IACN,MAAM;IACN,UAAU;IACV,UAAU;IACV,MAAM;IACN,SAAS;IACT,mBAAmB;IACnB,kBAAkB;IAClB,mCAAmC;IACnC,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;IACZ,gBAAgB;IAChB,SAAS;AACX;AAEA,0CAA0C;AAC1C,IAAI,OAA0B;AAKvB,SAAS;IACd,IAAI,CAAC,MAAM;QACT,OAAO,8IAAK,CAAC,UAAU,CAAC;YACtB,MAAM;YACN,MAAM;YACN,UAAU;YACV,UAAU;YACV,MAAM;YACN,SAAS;YACT,mBAAmB;YACnB,kBAAkB;YAClB,wDAAwD;YACxD,oBAAoB;YACpB,iBAAiB;YACjB,YAAY;QACd;IACF;IACA,OAAO;AACT;AAKO,eAAe;IACpB,IAAI;QACF,MAAM,aAAa,MAAM,8IAAK,CAAC,gBAAgB,CAAC;QAEhD,oDAAoD;QACpD,MAAM,WAAW,OAAO,CAAC;QACzB,MAAM,WAAW,OAAO,CAAC;QACzB,MAAM,WAAW,OAAO,CAAC;QACzB,MAAM,WAAW,OAAO,CAAC;QACzB,MAAM,WAAW,OAAO,CAAC;QAEzB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sCAAsC;QACpD,MAAM,IAAI,MACR,CAAC,oCAAoC,EAAE,iBAAiB,QAAQ,MAAM,OAAO,GAAG,sBAAsB;IAE1G;AACF;AAKO,eAAe,aAAsB,GAAW,EAAE,SAAgB,EAAE;IACzE,MAAM,aAAa,MAAM;IACzB,IAAI;QACF,MAAM,CAAC,KAAK,GAAG,MAAM,WAAW,OAAO,CAAC,KAAK;QAC7C,OAAO;IACT,SAAU;QACR,MAAM,WAAW,GAAG;IACtB;AACF;AAKO,eAAe,iBAA0B,GAAW,EAAE,SAAgB,EAAE;IAC7E,MAAM,OAAO;IACb,MAAM,CAAC,KAAK,GAAG,MAAM,KAAK,OAAO,CAAC,KAAK;IACvC,OAAO;AACT;AAKO,eAAe;IACpB,IAAI,MAAM;QACR,MAAM,KAAK,GAAG;QACd,OAAO;IACT;AACF;AAKO,eAAe;IACpB,IAAI;QACF,MAAM,aAAa,MAAM;QACzB,MAAM,WAAW,OAAO,CAAC;QACzB,MAAM,WAAW,GAAG;QACpB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yCAAyC;QACvD,OAAO;IACT;AACF;AAKO,eAAe;IAMpB,MAAM,aAAa,MAAM;IACzB,IAAI;QACF,MAAM,CAAC,KAAK,GAAG,MAAM,WAAW,OAAO,CAAC,CAAC;;;;;;IAMzC,CAAC;QAED,MAAM,SAAS,AAAC,IAAc,CAAC,EAAE;QACjC,MAAM,WAAW,GAAG;QAEpB,OAAO;YACL,UAAU,OAAO,QAAQ;YACzB,QAAQ,OAAO,MAAM;YACrB,YAAY,OAAO,UAAU;YAC7B,SAAS,OAAO,OAAO;QACzB;IACF,EAAE,OAAO,OAAO;QACd,MAAM,WAAW,GAAG;QACpB,MAAM;IACR;AACF","debugId":null}},
    {"offset": {"line": 263, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projekte/lopez-it-welt/src/app/api/ab/variant/route.ts"],"sourcesContent":["/**\n * GET /api/ab/variant\n * Ermittelt, welche Variante ein Nutzer sehen soll\n * Prüft: ab_active, split_a\n * Liefert zufällig oder gezielt Variante A/B zurück\n * Loggt Event in ab_events (type='view')\n */\n\nimport { createConnection } from \"@/lib/db\";\nimport { NextRequest, NextResponse } from \"next/server\";\nimport crypto from \"crypto\";\n\nexport async function GET(request: NextRequest) {\n  try {\n    const connection = await createConnection();\n\n    // 1. Prüfe ob A/B-Testing aktiv ist\n    const [configRows] = await connection.execute(\"SELECT * FROM ab_config WHERE id = 1\");\n\n    if (!Array.isArray(configRows) || configRows.length === 0) {\n      await connection.end();\n      return NextResponse.json(\n        { error: \"A/B-Testing Konfiguration nicht gefunden\" },\n        { status: 404 },\n      );\n    }\n\n    const config = configRows[0] as any;\n\n    if (!config.ab_active) {\n      await connection.end();\n      return NextResponse.json({\n        active: false,\n        variant: null,\n        message: \"A/B-Testing ist deaktiviert\",\n      });\n    }\n\n    // 2. Finde aktives Experiment\n    const [experimentRows] = await connection.execute(\n      `SELECT * FROM ab_experiments \n       WHERE status = 'running' \n       AND (start_date IS NULL OR start_date <= NOW())\n       AND (end_date IS NULL OR end_date >= NOW())\n       ORDER BY created_at DESC \n       LIMIT 1`,\n    );\n\n    if (!Array.isArray(experimentRows) || experimentRows.length === 0) {\n      await connection.end();\n      return NextResponse.json({\n        active: false,\n        variant: null,\n        message: \"Kein aktives Experiment gefunden\",\n      });\n    }\n\n    const experiment = experimentRows[0] as any;\n\n    // 3. Lade Varianten\n    const [variantRows] = await connection.execute(\n      \"SELECT * FROM ab_variants WHERE experiment_id = ? ORDER BY variant_key\",\n      [experiment.id],\n    );\n\n    if (!Array.isArray(variantRows) || variantRows.length === 0) {\n      await connection.end();\n      return NextResponse.json(\n        { error: \"Keine Varianten für dieses Experiment gefunden\" },\n        { status: 404 },\n      );\n    }\n\n    // 4. User-Hash generieren (anonymisiert, DSGVO-konform)\n    const userAgent = request.headers.get(\"user-agent\") || \"\";\n    const ipAddress =\n      request.headers.get(\"x-forwarded-for\") || request.headers.get(\"x-real-ip\") || \"unknown\";\n    const userHash = crypto.createHash(\"sha256\").update(`${userAgent}-${ipAddress}`).digest(\"hex\");\n\n    // 5. Device-Type erkennen\n    const deviceType = userAgent.includes(\"Mobile\")\n      ? \"mobile\"\n      : userAgent.includes(\"Tablet\")\n        ? \"tablet\"\n        : \"desktop\";\n\n    // 6. Variante zuweisen (konsistent basierend auf User-Hash)\n    const hashValue = parseInt(userHash.substring(0, 8), 16);\n    const splitPercentage = experiment.split_a || config.default_split;\n    const variantIndex = hashValue % 100 < splitPercentage ? 0 : 1;\n    const selectedVariant = variantRows[variantIndex] || variantRows[0];\n\n    // 7. Event loggen (view)\n    await connection.execute(\n      `INSERT INTO ab_events \n       (experiment_id, variant_key, event_type, user_hash, device_type) \n       VALUES (?, ?, 'view', ?, ?)`,\n      [experiment.id, selectedVariant.variant_key, userHash, deviceType],\n    );\n\n    // 8. Impression-Zähler erhöhen\n    await connection.execute(\n      `UPDATE ab_variants \n       SET impressions = impressions + 1, updated_at = CURRENT_TIMESTAMP \n       WHERE id = ?`,\n      [selectedVariant.id],\n    );\n\n    await connection.end();\n\n    // 9. Variante zurückgeben\n    return NextResponse.json(\n      {\n        active: true,\n        experiment_id: experiment.id,\n        experiment_name: experiment.name,\n        variant: {\n          key: selectedVariant.variant_key,\n          title: selectedVariant.title,\n          subtitle: selectedVariant.subtitle,\n          description: selectedVariant.description,\n          button_text: selectedVariant.button_text,\n          button_link: selectedVariant.button_link,\n        },\n        split_a: experiment.split_a,\n        device_type: deviceType,\n      },\n      {\n        headers: {\n          \"Content-Type\": \"application/json; charset=utf-8\",\n        },\n      },\n    );\n  } catch (error) {\n    console.error(\"❌ A/B Variant API Fehler:\", error);\n    return NextResponse.json(\n      {\n        error: \"Fehler beim Abrufen der Variante\",\n        details: error instanceof Error ? error.message : \"Unbekannter Fehler\",\n      },\n      { status: 500 },\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}